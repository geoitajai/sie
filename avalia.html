<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title> </title>
    <link rel="icon" type="image/png" href="images/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="images/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="images/favicon-32x32.png" sizes="32x32">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <link rel="stylesheet" href="lib/leaflet.css" />
    <link rel="stylesheet" href="lib/MarkerCluster.css" />
    <link rel="stylesheet" href="lib/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="lib/leaflet-search.min.css" />
</head>

<style>
    body {
        margin: 0;
        padding: 0;
    }

    #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
    }

    .leaflet-container {
        background: #ffffff;
    }
</style>

<body>
    <div id="map"></div>

    <script src="lib/leaflet.js"></script>
    <script src="lib/jquery-3.3.1.min.js"></script>
    <script src="lib/csv2geojson.js"></script>
    <script src="lib/leaflet.markercluster.js"></script>
    <script src="lib/leaflet.markercluster.layersupport.js"></script>
    <script src="lib/leaflet-search.min.js"></script>
    <script src="lib/leaflet.tilelayer.fallback.js"></script>
    <script src="lib/leaflet-hash.js"></script>

    <script>
        //camadas a serem manipuladas
        var tilesmu = new L.LayerGroup();
        var tilegoogle = new L.LayerGroup();
        var pesquisa = new L.LayerGroup();
        var avaliacoes = new L.LayerGroup();

        //div do mapa
        var map = new L.Map('map', {
            zoom: 14,
            minZoom: 12,
            maxZoom: 18,
            maxBounds: [
                //south west
                [-27.215341, -49.020370],
                //north east
                [-26.701009, -48.397961]
            ],
            center: new L.latLng([-26.906960, -48.685425]),
            zoomControl: false,
            layers: [tilesmu]
        });

        //hash, acesso a coordenadas e zoom pela barra de endereços ex: .html#12/37.7631/-122.4437
		var hash = new L.Hash(map);

        //marca d´água
        L.Control.Watermark = L.Control.extend({
            onAdd: function (map) {
                var img = L.DomUtil.create('img');

                img.src = 'images/brasa.png';
                img.style.width = '320px';

                return img;
            },
            onRemove: function (map) { }
        });

        L.control.watermark = function (opts) {
            return new L.Control.Watermark(opts);
        }
        L.control.watermark({ position: 'topleft' }).addTo(map);

        //barra escala
        L.control.scale({ imperial: false }).addTo(map);

        //google image
        new L.TileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            opacity: 0.6,
            maxZoom: 19,
            transparent: false,
            attribution: '©2018 Google, SMU/Porto, <a href="mailto:jaceguay@itajai.sc.gov.br?Subject=WebGIS" target="_top">SIE</a>',
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
        }).addTo(tilegoogle);

        //zona urbana e geral
        L.tileLayer.fallback('tiles/basemap/10-17/{z}/{x}/{y}.png', {
            opacity: 0.6,
            minZoom: 10,
            attribution: 'SMU/Porto, <a href="mailto:jaceguay@itajai.sc.gov.br?Subject=WebGIS" target="_top">SIE</a>',
            maxZoom: 19
        }).addTo(tilesmu);

        //zona rural, zoom 17
        L.tileLayer.fallback('tiles/basemap/17rural/{z}/{x}/{y}.png', {
            opacity: 0.6,
            minZoom: 17,
            maxZoom: 19
        }).addTo(tilesmu);

        //bairros
        map.addLayer(new L.TileLayer('tiles/bairros/{z}/{x}/{y}.png', {
            opacity: 0.5,
            minZoom: 10,
            maxZoom: 14
        }));

        //Clustering com suporte a camadas
        var mcg = L.markerClusterGroup.layerSupport({ disableClusteringAtZoom: 15 }).addTo(map);
        mcg.checkIn([avaliacoes]);
        avaliacoes.addTo(map);

        //Avaliações
        $.ajax({
            type: "GET",
            url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSfmnhu6-ia1AQmoO5eKO3cuwyReuRnqXwShzz0CcDI7SZ7SeNmbzt6JfXjXuXsbYngjSQE99Gzu10g/pub?gid=0&single=true&output=tsv",
            dataType: "text",
            success: function (data) {
                csv2geojson.csv2geojson(data,
                    {
                        latfield: 'latitude',
                        lonfield: 'longitude',
                        delimiter: '\t'
                    },
                    function (err, data) {
                        L.geoJSON(data, {
							pointToLayer: function (feature, latlng) {
								let marker = L.marker(latlng);
								marker.bindPopup(
									'<strong>' + '<u>' + feature.properties.nome + '</u>' + '</strong>' + '<br/>' +
									'Endereço: ' + feature.properties.end + '<br/>' +
									'Data: ' + feature.properties.data + '<br/>' +
									'Área: ' + feature.properties.area + '<br/>' +
									'Testada x Profundidade: ' + feature.properties.testadaxprof + '<br/>' +
                                    'Valor: ' + feature.properties.valort + '<br/>' +
									'Zoneamento: ' + feature.properties.zon
								);
								return marker;
							}
                        }).addTo(avaliacoes).addTo(pesquisa);
                    });
            }
        });

        //Sistema viário para pesquisa
        $.ajax({
            type: "GET",
            url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBLSrcsNMwpbaF1ShxlSLeX7CdHAmOkX452MEoYgDEbMIF41DJmvN4Y2yv6Ge0nOp8DDh4B4r40xQG/pub?gid=828218726&single=true&output=tsv",
            dataType: "text",
            success: function (data) {
                csv2geojson.csv2geojson(data,
                    {
                        latfield: 'latitude',
                        lonfield: 'longitude',
                        delimiter: '\t'
                    },
                    function (err, data) {
                        L.geoJSON(data).addTo(pesquisa);
                    });
            }
        });

        //Barra pesquisa
        var searchControl = new L.Control.Search({
            layer: pesquisa,
            propertyName: 'nome',
            circleLocation: false,
            marker: false,
            textPlaceholder: "Pesquisa logradouro ou nome avaliação",
            textErr: "Não localizado",
            textCancel: "Cancelar",
            zoom: 17,
            openPopup: false,
            collapsed: false,
            initial: false,
            position: 'topleft',
            minLength: 1
        });
        map.addControl(searchControl);
        //camada não precisa ser visível, apenas para searchcontrol
        map.removeLayer(pesquisa);

		//Controle de camadas mapas fundo
		var baseMaps = {
			"Sistema viário": tilesmu,
			"Imagem, Google maps": tilegoogle
		};
		L.control.layers(baseMaps, null, { collapsed: false, position: 'topleft' }).addTo(map);

        //Botão zoom posicionado
        L.control.zoom({
            position: 'topleft'
        }).addTo(map);

    </script>
</body>

</html>
