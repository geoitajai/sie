<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>FAMAI - LAI</title>
		<link rel="icon" type="image/png" href="images/favicon-96x96.png" sizes="96x96">
		<link rel="icon" type="image/png" href="images/favicon-16x16.png" sizes="16x16">
		<link rel="icon" type="image/png" href="images/favicon-32x32.png" sizes="32x32">
		<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
		<link rel="stylesheet" href="lib/leaflet.css" />
		<link rel="stylesheet" href="lib/leaflet-search.min.css" />
		<link rel="stylesheet" href="lib/leaflet.draw.css" />
		<link rel="stylesheet" href="lib/L.Control.MousePosition.css" />
		<link rel="stylesheet" href="lib/MarkerCluster.css" />
		<link rel="stylesheet" href="lib/MarkerCluster.Default.css" />

		<style>
			body {
				margin: 0;
				padding: 0;
			}

			#map {
				position: absolute;
				top: 0;
				bottom: 0;
				width: 100%;
			}

			.leaflet-container {
				background: #ffffff;
			}

			td, th {
				border: 1px solid #dddddd;
			}

			.legend {
				padding: 6px 8px;
				text-align: left;
				line-height: 18px;
				color: #555;
				background : white;
				box-shadow: 0 0 15px rgba(0,0,0,0.2);
				border-radius: 5px;
			}

			.legend i {
				width: 18px;
				height: 18px;
				float: left;
				margin-right: 20px;
			}

				.legend .circle {
				border-radius: 20%;
				width: 15px;
				height: 15px;
			}

			.leaflet-control-draw-measure {
				background-image: url(images/measure-control.png);
			}
			
			.leaflet-container .leaflet-control-search {				
				left: 2px;
			}			
		</style>
	</head>

	<body>
		<div id="map"></div>
		<script src="lib/leaflet.js"></script>
		<script src="lib/leaflet-search.min.js"></script>
		<script src="lib/leaflet-omnivore.min.js"></script>
		<script src="lib/leaflet.markercluster.js"></script>
		<script src="lib/L.Control.MousePosition.js"></script>
		<script src="lib/leaflet.draw.js"></script>
		<script src="lib/leaflet.measurecontrol.min.js"></script>
		<script>

		var tilegoogle = L.layerGroup();
		var tilesmu = new L.LayerGroup();
		var pesquisa = new L.LayerGroup();
		//var laivalidos = new L.LayerGroup();
		//var laivencidos = new L.LayerGroup();

		//div do mapa
		var map = new L.Map('map', {
			zoom: 14,
			minZoom: 12,
			maxZoom: 17,
			maxBounds: [
				//south west
				[-27.1279, -48.8954],
				//north east
				[-26.8074, -48.5845]
			],
			center: new L.latLng([-26.906960, -48.685425]),
			layers:[ tilesmu ],
			measureControl: true
		});

		//coordenadas
		L.control.mousePosition().addTo(map);

		//barra escala
		L.control.scale({imperial: false}).addTo(map);

		//marca d´água
		L.Control.Watermark = L.Control.extend({
			onAdd: function(map) {
				var img = L.DomUtil.create('img');

				img.src = 'images/brasaofamai.png';
				img.style.width = '150px';

				return img;
			},
			onRemove: function(map) {}
		});

		L.control.watermark = function(opts) {
			return new L.Control.Watermark(opts);
		}
		L.control.watermark({ position: 'bottomleft' }).addTo(map);

		//Mapa base, google
		new L.TileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{
			opacity: 0.6,
			maxZoom: 19,
			transparent: false,
			attribution: '©2018 Google, Fundação do Meio Ambiente de Itajaí, <a href="mailto:jaceguay@itajai.sc.gov.br?Subject=WebGIS" target="_top">SIE</a>',
			subdomains:['mt0','mt1','mt2','mt3']
		}).addTo(tilegoogle);

		//zona urbana e geral
		new L.TileLayer('tiles/basemap/10-17/{z}/{x}/{y}.png', {
			opacity: 0.6,
			minZoom: 10,
			attribution: 'Fundação do Meio Ambiente de Itajaí, <a href="mailto:jaceguay@itajai.sc.gov.br?Subject=WebGIS" target="_top">SIE</a>',
			maxZoom: 17
		}).addTo(tilesmu);

		//zona rural, zoom 17
		new L.TileLayer('tiles/basemap/17rural/{z}/{x}/{y}.png', {
			opacity: 0.6,
			minZoom: 17,
			maxZoom: 17
		}).addTo(tilesmu);

		//bairros
		map.addLayer(new L.TileLayer('tiles/bairros/{z}/{x}/{y}.png', {
			opacity: 0.5,
			minZoom: 10,
			maxZoom: 14
		}));

	//pesquisa, sistema viário
	omnivore.csv('https://docs.google.com/spreadsheets/d/e/2PACX-1vQBLSrcsNMwpbaF1ShxlSLeX7CdHAmOkX452MEoYgDEbMIF41DJmvN4Y2yv6Ge0nOp8DDh4B4r40xQG/pub?gid=828218726&single=true&output=csv').addTo(pesquisa);

	//pesquisa, LAI
	omnivore.csv('https://docs.google.com/spreadsheets/d/e/2PACX-1vQX0lq-pp7xVvu89vfuwpCSwuVNA_TmzQ4FJhGHwY58BPjzJ414OE9NpMyw2UWUw3B81RATYH_ImiXY/pub?gid=394865370&single=true&output=csv').addTo(pesquisa);

		var searchControl = new L.Control.Search({
			layer: pesquisa,
			propertyName: 'nome',
			circleLocation: false,
			hideMarkerOnCollapse: true,
			textPlaceholder: "Pesquisa logradouro ou nº licença",
			textErr: "Não localizado",
			textCancel: "Cancelar",
			zoom: 17,
			openPopup: false,
			initial: false
		});

		map.addControl(searchControl);
		//camada não precisa ser visível, apenas para searchcontrol
		map.removeLayer(pesquisa);

		//marker cluster
		var clusterGroup = new L.MarkerClusterGroup({ disableClusteringAtZoom: 16 });
		map.addLayer(clusterGroup);

		//LAI vencidos
		var laivicon = L.icon({
			iconUrl: 'images/lavenc.png',
			iconAnchor:   [16,60],
			popupAnchor:  [0,-50],
			iconSize: [33,60]
		});

		omnivore.csv('https://docs.google.com/spreadsheets/d/e/2PACX-1vQX0lq-pp7xVvu89vfuwpCSwuVNA_TmzQ4FJhGHwY58BPjzJ414OE9NpMyw2UWUw3B81RATYH_ImiXY/pub?gid=809216463&single=true&output=csv')
		.on('ready', function(layer) {

			this.eachLayer(function(marker) {
				marker.setIcon(laivicon);
				marker.bindPopup(
					'<strong>' + '<u>' + marker.toGeoJSON().properties.num + '</u>' + '</strong>' + '<br/>' +
					'Requerente: ' + marker.toGeoJSON().properties.req + '<br/>' +
					'Endereço: ' + marker.toGeoJSON().properties.end + ', ' + marker.toGeoJSON().properties.bairro + '<br/>' +
					'Data de emissão: ' + marker.toGeoJSON().properties.dataemi+ '<br/>' +
					'Data de vencimento: ' + marker.toGeoJSON().properties.datavali + '<br/>' +
					'Atividade: ' + marker.toGeoJSON().properties.ativdescr
				);
			});
			this.eachLayer(function(layer) {
				clusterGroup.addLayer(layer);
				//laivencidos.addLayer(layer);
			});
		});

		//LAI válidos
		var lairicon = L.icon({
			iconUrl: 'images/laib.png',
			iconAnchor:   [16,60],
			popupAnchor:  [0,-50],
			iconSize: [33,60]
		});

		var laicicon = L.icon({
			iconUrl: 'images/laig.png',
			iconAnchor:   [16,60],
			popupAnchor:  [0,-50],
			iconSize: [33,60]
		});

		var laiiicon = L.icon({
			iconUrl: 'images/lair.png',
			iconAnchor:   [16,60],
			popupAnchor:  [0,-50],
			iconSize: [33,60]
		});

		omnivore.csv('https://docs.google.com/spreadsheets/d/e/2PACX-1vQX0lq-pp7xVvu89vfuwpCSwuVNA_TmzQ4FJhGHwY58BPjzJ414OE9NpMyw2UWUw3B81RATYH_ImiXY/pub?gid=1518212428&single=true&output=csv')
		.on('ready', function(layer) {

			this.eachLayer(function(marker) {
				//ícones
				if (marker.toGeoJSON().properties.ativtipo === 'residencial') {
					marker.setIcon(lairicon);
				}
				else if (marker.toGeoJSON().properties.ativtipo === 'comercial') {
					marker.setIcon(laicicon);
				}
				else {
					marker.setIcon(laiiicon);
				}


				marker.bindPopup(
					'<strong>' + '<u>' + marker.toGeoJSON().properties.num + '</u>' + '</strong>' + '<br/>' +
					'Requerente: ' + marker.toGeoJSON().properties.req + '<br/>' +
					'Endereço: ' + marker.toGeoJSON().properties.end + ', ' + marker.toGeoJSON().properties.bairro + '<br/>' +
					'Data de emissão: ' + marker.toGeoJSON().properties.dataemi + '<br/>' +
					'Data de vencimento: ' + marker.toGeoJSON().properties.datavali + '<br/>' +
					'Atividade: ' + marker.toGeoJSON().properties.ativdescr
				);
			});
			this.eachLayer(function(layer) {
				clusterGroup.addLayer(layer);
				//laivalidos.addLayer(layer);
			});
		});

		//Controle de camadas
		var baseMaps = {
			"Sistema viário" : tilesmu,
			"Imagem, Google maps" : tilegoogle
		};
		L.control.layers(baseMaps, null,{position: 'topleft'}).addTo(map);

		//coordenadas no click
		var popup = L.popup();

		function onMapClick(e) {
		popup
			.setLatLng(e.latlng)
			.setContent(e.latlng.toString())
			.openOn(map);
		}

		map.on('click', onMapClick);

		</script>
	</body>
</html>