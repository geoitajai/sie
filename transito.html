<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>Diretoria de Fiscalização e Controle de Trânsito</title>
		<link rel="icon" type="image/png" href="images/favicon-96x96.png" sizes="96x96">
		<link rel="icon" type="image/png" href="images/favicon-16x16.png" sizes="16x16">
		<link rel="icon" type="image/png" href="images/favicon-32x32.png" sizes="32x32">
		<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
		<link rel="stylesheet" href="lib/leaflet.css" />
		<link rel="stylesheet" href="lib/leaflet-search.min.css" />
		<link rel="stylesheet" href="lib/leaflet.draw.css" />
		<link rel="stylesheet" href="lib/L.Control.MousePosition.css" />
		<link rel="stylesheet" href="lib/MarkerCluster.css" />
		<link rel="stylesheet" href="lib/MarkerCluster.Default.css" />

		<style>
			body {
				margin: 0;
				padding: 0;
			}

			#map {
				position: absolute;
				top: 0;
				bottom: 0;
				width: 100%;
			}

			.leaflet-container {
				background: #ffffff;
			}

			td, th {
				border: 1px solid #dddddd;
			}

			.legend {
				padding: 6px 8px;
				text-align: left;
				line-height: 18px;
				color: #555;
				background : white;
				box-shadow: 0 0 15px rgba(0,0,0,0.2);
				border-radius: 5px;
			}

			.legend i {
				width: 18px;
				height: 18px;
				float: left;
				margin-right: 20px;
			}

				.legend .circle {
				border-radius: 20%;
				width: 15px;
				height: 15px;
			}

			.leaflet-control-draw-measure {
				background-image: url(images/measure-control.png);
			}

			.leaflet-container .leaflet-control-search {
				left: 2px;
			}
		</style>
	</head>

	<body>
		<div id="map"></div>

		<script src="lib/leaflet.js"></script>
		<script src="lib/leaflet-search.min.js"></script>
		<script src="lib/leaflet-omnivore.min.js"></script>
		<script src="lib/leaflet.markercluster.js"></script>
		<script src="lib/L.Control.MousePosition.js"></script>
		<script src="lib/leaflet.draw.js"></script>
		<script src="lib/leaflet.measurecontrol.min.js"></script>
		<script src="lib/leaflet.markercluster.layersupport.js"></script>
		<script src="lib/leaflet-hash.js"></script>
		<script src="lib/leaflet-heat.js"></script>

		<script>
		var tilegoogle = new L.layerGroup();
		var tilesmu = new L.LayerGroup();
		var pesquisa = new L.LayerGroup();
		var ocorr = new L.LayerGroup();//ocorrências
		var ocorrcoord = [];//coordenadas para leaflet.heat

		//div do mapa
		var map = new L.Map('map', {
			zoom: 14,
			minZoom: 12,
			maxZoom: 17,
			maxBounds: [
				//south west
				[-27.1279, -48.8954],
				//north east
				[-26.8074, -48.5845]
			],
			center: new L.latLng([-26.91189, -48.69535]),
			layers:[ tilesmu ],
			measureControl: true
		});

		//hash, acesso a coordenadas e zoom pela barra de endereços ex: .html#12/37.7631/-122.4437
		var hash = new L.Hash(map);

		//coordenadas
		L.control.mousePosition().addTo(map);

		//barra escala
		L.control.scale({imperial: false}).addTo(map);

		//marca d´água
		L.Control.Watermark = L.Control.extend({
			onAdd: function(map) {
				var img = L.DomUtil.create('img');

				img.src = 'images/logoico.png';
				img.style.width = '150px';

				return img;
			},
			onRemove: function(map) {}
		});

		L.control.watermark = function(opts) {
			return new L.Control.Watermark(opts);
		};
		L.control.watermark({ position: 'bottomleft' }).addTo(map);

		//Mapa base, google
		new L.TileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{
			opacity: 0.6,
			maxZoom: 19,
			transparent: false,
			attribution: '©2018 Google, Diretoria de Fiscalização e Controle de Trânsito, <a href="mailto:jaceguay@itajai.sc.gov.br?Subject=WebGIS" target="_top">SIE</a>',
			subdomains:['mt0','mt1','mt2','mt3']
		}).addTo(tilegoogle);

		//zona urbana e geral
		new L.TileLayer('tiles/basemap/10-17/{z}/{x}/{y}.png', {
			opacity: 0.6,
			minZoom: 10,
			attribution: 'Diretoria de Fiscalização e Controle de Trânsito, <a href="mailto:jaceguay@itajai.sc.gov.br?Subject=WebGIS" target="_top">SIE</a>',
			maxZoom: 17
		}).addTo(tilesmu);

		//zona rural, zoom 17
		new L.TileLayer('tiles/basemap/17rural/{z}/{x}/{y}.png', {
			opacity: 0.6,
			minZoom: 17,
			maxZoom: 17
		}).addTo(tilesmu);

		//bairros
		map.addLayer(new L.TileLayer('tiles/bairros/{z}/{x}/{y}.png', {
			opacity: 0.5,
			minZoom: 10,
			maxZoom: 14
		}));

		//pesquisa, sistema viário
		omnivore.csv('https://docs.google.com/spreadsheets/d/e/2PACX-1vQBLSrcsNMwpbaF1ShxlSLeX7CdHAmOkX452MEoYgDEbMIF41DJmvN4Y2yv6Ge0nOp8DDh4B4r40xQG/pub?gid=828218726&single=true&output=csv').addTo(pesquisa);

		var searchControl = new L.Control.Search({
			layer: pesquisa,
			propertyName: 'nome',
			circleLocation: false,
			hideMarkerOnCollapse: true,
			textPlaceholder: "Pesquisa nome logradouro",
			textErr: "Não localizado",
			textCancel: "Cancelar",
			zoom: 17,
			openPopup: false,
			initial: false
		});

		map.addControl(searchControl);
		//camada não precisa ser visível, apenas para searchcontrol
		map.removeLayer(pesquisa);

		//#Ocorrências#
		var sauicon = L.icon({
			iconUrl: 'images/dot.png',
			iconAnchor:   [10,10],
			popupAnchor:  [-10,-10],
			iconSize: [20,20]
		});

		omnivore.csv('https://docs.google.com/spreadsheets/d/e/2PACX-1vRCoaRgsophVs1tjdmstnz_xm2VPwAwwdZmi-4vkP0UlC7qrSTxqmNOOZkIMBpUY14VbKQDEXmlyvCi/pub?gid=660204247&single=true&output=csv')
		.on('ready', function(layer) {
			this.eachLayer(function(marker) {
				marker.setIcon(sauicon);
				//formatação para o Leaflet.heat, insere cada ponto no array, o último elemento é a intensidade
				ocorrcoord.push([marker.toGeoJSON().geometry.coordinates[1],marker.toGeoJSON().geometry.coordinates[0],0.4]);
			});
		}).addTo(ocorr);

		//marker clustering com suporte para layers
		var mcg = L.markerClusterGroup.layerSupport({ }).addTo(map);
		mcg.checkIn([ ocorr	]);
		ocorr.addTo(map);

		//legenda
		var legend = L.control({position: 'bottomright'});

		legend.onAdd = function (map) {
			var div = L.DomUtil.create('div');
			div.innerHTML = '<iframe src="https://docs.google.com/spreadsheets/d/e/2PACX-1vRdjqjBnRBuBR-OwQ0f10S5-wri8eDakuKSgYodGFIF2m5N6MuCNtnGwRyVi2HgyL0viUHf6CuhavGe/pubhtml?gid=1199396381&amp;single=true&amp;widget=false&amp;headers=false" width="470" height="145" frameborder="0" marginheight="0" marginwidth="0"></iframe>';
			return div;
		};
		legend.addTo(map);

		//mapa de calor
		var heatMap = new L.heatLayer(ocorrcoord,{blur:20, radius: 50});
		map.addLayer(heatMap);
		
		//controle camadas
		var baseMaps = {
			"Sistema viário" : tilesmu,
			"Imagem, Google maps" : tilegoogle
		};		
		L.control.layers(baseMaps, null,{position: 'topleft'}).addTo(map);
		
		//coordenadas no click
		var popup = L.popup();
		function onMapClick(e) {
		popup
			.setLatLng(e.latlng)
			.setContent(e.latlng.toString())
			.openOn(map);
		}
		map.on('click', onMapClick);		
		
		</script>
	</body>
</html>