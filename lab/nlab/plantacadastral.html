<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="utf-8" />
    <title>Planta Cadastral - SEFAZ</title>
    <link rel="icon" type="image/png" href="images/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="images/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="images/favicon-32x32.png" sizes="32x32">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <link rel="stylesheet" href="lib/leaflet.css" />
    <link rel="stylesheet" href="lib/jquery-ui.min.css" />
    <link rel="stylesheet" href="lib/jquery-ui.theme.min.css" />
    <link rel="stylesheet" href="lib/tabulator_simple.min.css" />
    <script src="lib/leaflet.js"></script>
    <script src="lib/jquery-3.3.1.min.js"></script>
    <script src="lib/jquery-ui.min.js"></script>
    <script src="lib/tabulator.min.js"></script>
    <script src="lib/leaflet.wms.js"></script>
    <script src="http://geo-smu.itajai.local/geo/lib/papaparse.min.js"></script>
</head>

<style>
    :root {
        --base: #00bcd4;
        --escuro: #333;
        --claro: #e9e9e9;
    }

    body {

        padding: 0;
        font-family: Arial, Helvetica, sans-serif;
    }

    .wrapper {
        display: grid;
        grid-template-rows: minmax(50px, 5%) minmax(200px, 75%) minmax(100px, 20%);
        grid-template-columns: 50% 50%;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        position: fixed;
    }

    .brasao {
        background: var(--base);
        background-image: url(images/favicon-96x96.png);
        background-repeat: no-repeat;
        background-size: 42px;
        background-position: left;
    }

    #brastitulo {
        padding-left: 50px;
        padding-top: 7px;
        display: flex;
        flex-direction: column;
        color: var(--claro);
        text-shadow: 1px 1px 2px black;
    }

    .bpesquisa {
        background: var(--claro);
        display: flex;
        align-items: center;
        padding-left: 10px;
    }

    .mapa {
        grid-column: 1/3;
    }

    .tabela {
        grid-column: 1/3;
    }

    @media (max-width: 700px) {
        .wrapper {
            grid-template-rows: minmax(50px, 5%) minmax(50px, 5%) minmax(200px, 75%) minmax(100px, 20%);
            grid-template-columns: 100%;
        }

        .brasao {
            grid-column: 1/3;
        }

        .pesquisa {
            grid-column: 1/3;
        }

        .mapa {
            grid-column: 1/3;
        }

        .tabela {
            grid-column: 1/3;
        }
    }

    .tabulator {
        font-size: 12px;
        background: var(--claro);
    }

    .tabulator .tabulator-header .tabulator-col {
        background: var(--base);
        color: var(--claro);
        text-shadow: 1px 1px 2px black;
    }

    .tabulator .tabulator-header {
        border-bottom: 0px;
    }

    .tabulator .tabulator-header,
    .tabulator .tabulator-header .tabulator-col {
        background-color: var(--base);
    }

    ul.ui-autocomplete {
        z-index: 402;
    }

    .leaflet-container {
        background: #ffffff;
    }

    .leaflet-default-icon-path {
        background-image: url(../images/marker-icon.png);
    }

    .leaflet-control-layers-toggle {
        background-image: url(../images/layers.png);
    }

    .leaflet-retina .leaflet-control-layers-toggle {
        background-image: url(../images/layers-2x.png);
    }
</style>

<body>
    <div class="wrapper">
        <div class="brasao" id="brastitulo">
            <span style="font-size: 13px;">Secretaria Municipal da Fazenda</span>
            <span style="font-size: 24px;"><b>Planta Cadastral</b></span>
        </div>
        <div class="bpesquisa">
            <form>
                <input id="pesquisaRapida" placeholder="Inscr.imobiliária, código ou nome logradouro" style="width: 318px;">
            </form>
        </div>
        <div class="mapa" id="mapa"></div>
        <div class="tabela" id="tabelatabulator"></div>
    </div>


    </div>

    <script>
        //div do mapa
        let mapa = new L.Map('mapa', {
            zoom: 14,
            minZoom: 11,
            maxZoom: 20,
            maxBounds: [
                //south west
                [-27.3000, -49.2300],
                //north east
                [-26.3285, -48.3200]
            ],
            center: new L.latLng([-26.9046, -48.6874]),
            zoomControl: false
        });

        //barra escala
        L.control.scale({ position: "bottomright", imperial: false }).addTo(mapa);

        //Norte
        let nortemapa = L.control({ position: 'bottomright' });

        nortemapa.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info2 legend');
            div.innerHTML +=
                '<center><sub><font size="4">▲</font></sub><br/>' +
                '<sup><font size="2">N</font></sup></center>'
            return div;
        };
        nortemapa.addTo(mapa);

        //Botão zoom posicionado
        L.control.zoom({ position: 'topright' }).addTo(mapa);

        //Mapa base, google
        new L.TileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            opacity: 0.6,
            maxZoom: 20,
            transparent: false,
            attribution: '©2018 Google, Itajaí/SC, <a href="mailto:jaceguay@itajai.sc.gov.br?Subject=WebGIS" target="_top">SIE</a>',
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
        }).addTo(mapa);

        //Curvas 10x10
        new L.tileLayer.wms('http://10.10.1.158:8080/geoserver/ows?', {
            layers: 'geoitj:curvas10x10govest2013',
            format: 'image/png8',
            minZoom: 16,
            maxZoom: 20,
            attribution: false,
            transparent: true
        }).addTo(mapa);

        //Limites Município
        $.getJSON("http://geo-smu.itajai.local:8080/geoserver/geoitj/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=geoitj:geo2007limitesmunicip&outputFormat=application%2Fjson", function (data) {
            L.geoJson(data, {
                style: (feature) => {
                    return {
                        color: '#000000',
                        fill: false
                    };
                },
            }).addTo(mapa);
        });

        //Cadastro
        //Definir elementos da tabela
        let table = new Tabulator("#tabelatabulator", {
            height: "100%",
            layout: "fitColumns",
            columns: [
                { title: "nºCadastro", field: "ncodimov", width: 98 },
                { title: "Inscrição imob.", field: "ninscrao", width: 160 },
                { title: "Razão social", field: "nrazaoso", width: 350 },
                { title: "Tipo", field: "ntipopes", width: 60 },
                { title: "CNPJ/CPF", field: "nncpfpj", width: 110 },
                { title: "Logradouro", field: "nlogrado", width: 150 },
                { title: "nº", field: "nnumimov", width: 60 },
                { title: "Compl.", field: "ncomplem", width: 120 },
                { title: "CEP", field: "nceplogr", width: 70 },
                { title: "Bairro", field: "nnomebai", width: 100 },
                { title: "Testada", field: "ntestapr", width: 90 },
                { title: "Profund.", field: "nmfundos", width: 90 },
                { title: "Área terreno", field: "nareater", width: 110 },
                { title: "nº matrícula", field: "nmatricu", width: 110 },
                { title: "Cód.contrib.", field: "ncodcont", width: 110 },
                { title: "Fração ideal informada", field: "nfracaoi", width: 90 }
            ]
        });

        //Barra de pesquisa
        //tabela substituições
        let accentMap = {
            'á': 'a',
            'à': 'a',
            'ã': 'a',
            'â': 'a',
            'ç': 'c',
            'é': 'e',
            'è': 'e',
            'í': 'i',
            'ì': 'i',
            'ó': 'o',
            'ò': 'o',
            'õ': 'o',
            'ô': 'o',
            'ú': 'u',
            'ù': 'u'
        };
        //substituição de caracteres especiais
        let normalize = (term) => {
            let ret = "";
            for (let i = 0; i < term.length; i++) {
                ret += accentMap[term.charAt(i)] || term.charAt(i);
            }
            return ret;
        };

        //função de pesquisa
        let sviario;
        let pesquisaQvias = L.featureGroup().addTo(mapa);
        let pesquisaL = L.featureGroup().addTo(mapa);
        let nomespesquisa = new Promise((resolve, reject) => {
            $.getJSON("http://geo-smu.itajai.local:8080/geoserver/geoitj/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=geoitj:viewsistemaviario&outputFormat=application%2Fjson", function (data) {
                //L.geoJson(data).addTo(sviario);
                sviario = data;
                resolve(data.features.map((feicoes) => {
                    return feicoes.properties.nome
                }));
            });
        });

        nomespesquisa.then((result) => {
            $(() => {
                $("#pesquisaRapida").autocomplete({
                    minLength: 3,
                    autoFocus: true,
                    source: (request, response) => {
                        let matcher = new RegExp($.ui.autocomplete.escapeRegex(request.term), "i");
                        response($.grep(result, (value) => {
                            value = value.label || value.value || value;
                            return matcher.test(value) || matcher.test(normalize(value));
                        }));
                    },
                    select: (event, ui) => {
                        let filtradoobj = sviario.features.find(e => e.properties.nome === ui.item.value);
                        pesquisaQvias.clearLayers();
                        L.geoJson(filtradoobj, {
                            style: (feature) => {
                                return { weight: 5, color: "#ffff00", dashArray: "30 10", opacity: 0.6, interactive: false };
                            }
                        }).addTo(pesquisaQvias);
                        mapa.flyToBounds(pesquisaQvias.getBounds(), { maxZoom: 19 });
                    },
                    close: (e) => {
                        e.target.value = '';
                    }
                }).keypress((event) => {
                    if (event.keyCode == 13) {
                        event.preventDefault();
                        if ($("#pesquisaRapida").val().includes(".")) {
                            $.getJSON("http://geo-smu.itajai.local:8080/geoserver/wfs?service=wfs&version=1.0.0&request=getfeature&typename=geoitj:tmimgeom&outputFormat=application%2Fjson&CQL_FILTER=inscricao='" + $("#pesquisaRapida").val() + "'", function (data) {
                                //console.log(data.features[0].properties.inscrlig);
                                pesquisaL.clearLayers();
                                if (data.totalFeatures === 0) { alert('não encontrado'); }
                                else {
                                    L.geoJson(data, {
                                        style: (feature) => {
                                            return { color: '#000000', fill: false, weight: 5 }
                                        }
                                    }).addTo(pesquisaL);
                                    mapa.flyToBounds(pesquisaL.getBounds(), { maxZoom: 19 });
                                    Papa.parse("http://geo-smu.itajai.local:8080/geoserver/geoitj/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=geoitj:tmicad&outputFormat=csv&CQL_FILTER=inscrlig='" + data.features[0].properties.inscrlig + "'", {
                                        download: true,
                                        header: true,
                                        skipEmptyLines: true,
                                        complete: (results) => {
                                            table.setData(results.data);
                                        }
                                    });
                                };
                            });
                        } else {
                            $.getJSON("http://geo-smu.itajai.local:8080/geoserver/wfs?service=wfs&version=1.0.0&request=getfeature&typename=geoitj:tmimgeom&outputFormat=application%2Fjson&CQL_FILTER=ncodimov='" + $("#pesquisaRapida").val() + "'", function (data) {
                                pesquisaL.clearLayers();
                                if (data.totalFeatures === 0) { alert('não encontrado'); }
                                else {
                                    L.geoJson(data, {
                                        style: (feature) => {
                                            return { color: '#000000', fill: false, weight: 5 }
                                        }
                                    }).addTo(pesquisaL);
                                    mapa.flyToBounds(pesquisaL.getBounds(), { maxZoom: 19 });
                                    Papa.parse("http://geo-smu.itajai.local:8080/geoserver/geoitj/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=geoitj:tmicad&outputFormat=csv&CQL_FILTER=inscrlig='" + data.features[0].properties.inscrlig + "'", {
                                        download: true,
                                        header: true,
                                        skipEmptyLines: true,
                                        complete: (results) => {
                                            table.setData(results.data);
                                        }
                                    });
                                };
                            });
                        };
                        $("#pesquisaRapida").val("");
                    }
                });
            });
        });

        //WMS
        let CleanInfoSource = L.WMS.Source.extend({
            'showFeatureInfo': function (latlng, info) {
                if (!this._map) { return };
                pesquisaL.clearLayers();
                let liginscr = info.split(/\n|=/)[7].trim();
                $.getJSON("http://geo-smu.itajai.local:8080/geoserver/wfs?service=wfs&version=1.0.0&request=getfeature&typename=geoitj:tmimgeom&outputFormat=application%2Fjson&CQL_FILTER=inscrlig='" + liginscr + "'",
                    (data) => {
                        L.geoJson(data, {
                            style: (feature) => {
                                return { color: '#000000', fill: false, weight: 5 }
                            }
                        }).addTo(pesquisaL);
                    });
                //Tabela
                Papa.parse("http://geo-smu.itajai.local:8080/geoserver/geoitj/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=geoitj:tmicad&outputFormat=csv&CQL_FILTER=inscrlig='" + liginscr + "'", {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: function (results) {
                        //popular a tabela com os resultados
                        table.setData(results.data);
                    }
                });
                //legenda - ANTIGA
                let nadaencontrado = info.split(/\n|=/)[0];
                let vianomechk = info.split(/\n|=/)[16];
                let vianome = info.split(/\n|=/)[17];
                let vialeichk = info.split(/\n|=/)[14];
                let vialei = info.split(/\n|=/)[15];
                let viaptotalchk = info.split(/\n|=/)[8];
                let viaptotal = info.split(/\n|=/)[9];
                let passeioa = info.split(/\n|=/)[11];
                let passeiob = info.split(/\n|=/)[13];
                //campos
                let legendaA;
                let legendaB;
                let legendaC;
                //abastecer os campos'';
                if (nadaencontrado == 'no features were found') {
                    legendaA = 'clique sobre um elemento';
                    legendaB = '';
                    legendaC = '';
                };
                //legenda sistema viário
                if (vianomechk == 'nome ') {
                    info =
                        'Informações do logradouro:' + '<br/>' +
                        '<strong>' + vianome + '</strong>' + '<br/>' +
                        'Lei:' + vialei + '<br/>' +
                        'Cx.da via: ' + viaptotal + 'm' + ' - Passeios:' + passeioa + '/' + passeiob + 'm'
                        ;
                    this._map.openPopup(info, latlng);
                };
            }
        });
        let options = { 'transparent': true, 'info_format': 'text/plain', 'format': 'image/png8', 'tiled': true, minZoom: 10, maxZoom: 20, opacity: 0.7 };
        let source = new CleanInfoSource("http://geo-smu.itajai.local:8080/geoserver/geoitj/wms", options);
        source.addSubLayer('geoitj:hidrobase');
        source.addSubLayer('geoitj:hidrobasepoly');
        source.addSubLayer('geoitj:viewsistemaviarioestilosempauta');
        source.addSubLayer('geoitj:viewplantacadastralwms');
        source.addTo(mapa);

    </script>
</body>

</html>