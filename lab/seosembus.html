<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>SEOSEM, Paradas de ônibus - Itajaí-SC</title>
    <link rel="icon" type="image/png" href="http://geo-smu.itajai.local/geo/images/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="http://geo-smu.itajai.local/geo/images/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="http://geo-smu.itajai.local/geo/images/favicon-32x32.png" sizes="32x32">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <link rel="stylesheet" href="http://geo-smu.itajai.local/geo/lib/leaflet.css" />
    <link rel="stylesheet" href="http://geo-smu.itajai.local/geo/lib/jquery-ui.min.css" />
    <link rel="stylesheet" href="http://geo-smu.itajai.local/geo/lib/tabulator.min.css" />
    <link rel="stylesheet" href="http://geo-smu.itajai.local/geo/lib/MarkerCluster.css" />
    <link rel="stylesheet" href="http://geo-smu.itajai.local/geo/lib/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="http://geo-smu.itajai.local/geo/lib/leaflet-search.min.css" />
</head>

<style>
    body {
        margin: 0;
        padding: 0;
    }

    #map {
        position: absolute;
        top: 0;
        width: 100%;
        height: 75%;
    }

    .leaflet-container {
        background: #ffffff;
    }

    .linhatabela {
        position: absolute;
        bottom: 0;
        width: 99.5%;
        height: 25%;
    }

    .info {
        padding: 6px 8px;
        background: white;
        background: rgba(255, 255, 255, 0.8);
        box-shadow: 0 0 25px rgba(0, 0, 0, 0.3);
        border-radius: 0px;
    }

    .leaflet-container .leaflet-control-search {
        left: 1px;
    }
</style>

<body>
    <!-- Mapa -->
    <div id="map"></div>

    <!-- Tabela -->
    <div class="linhatabela" id="tabelatabulator"></div>

    <!-- Bibliotecas -->
    <script src="http://geo-smu.itajai.local/geo/lib/leaflet.js"></script>
    <script src="http://geo-smu.itajai.local/geo/lib/jquery-3.3.1.min.js"></script>
    <script src="http://geo-smu.itajai.local/geo/lib/jquery-ui.min.js"></script>
    <script src="http://geo-smu.itajai.local/geo/lib/tabulator.min.js"></script>
    <script src="http://geo-smu.itajai.local/geo/lib/leaflet.wms.js"></script>
    <script src="http://geo-smu.itajai.local/geo/lib/papaparse.min.js"></script>
    <script src="http://geo-smu.itajai.local/geo/lib/leaflet.markercluster.js"></script>
    <script src="http://geo-smu.itajai.local/geo/lib/leaflet-search.min.js"></script>

    <!-- Mapa -->
    <script>

        //div do mapa
        var map = new L.Map('map', {
            zoom: 14,
            minZoom: 12,
            maxZoom: 20,
            maxBounds: [
                //south west
                [-27.215341, -49.020370],
                //north east
                [-26.701009, -48.397961]
            ],
            center: new L.latLng([-26.906960, -48.685425]),
            zoomControl: false
        });

        //título
        var titulomapa = L.control({ position: 'topleft' });

        titulomapa.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info legend');
            div.innerHTML +=
                '<center><img src="http://geo-smu.itajai.local/geo/images/favicon-96x96.png" alt="brasao" width="60"><br/><strong><font size="6">SEOSEM</font></strong><br/>' +
                '<hr>' +
                '<strong><font size="4">Pontos de ônibus</font></strong><br/>' +
                '<font size="3">Manutenção e controle</font>'
            return div;
        };
        titulomapa.addTo(map);

        //Botão zoom posicionado
        L.control.zoom({ position: 'topleft' }).addTo(map);

        //Sistema viário para pesquisa
        var pesquisa = new L.LayerGroup();
        $.getJSON("http://geo-smu.itajai.local:8080/geoserver/geoitj/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=geoitj:viewsistemaviariopts&outputFormat=application%2Fjson", function (data) { L.geoJson(data).addTo(pesquisa) });

        //Barra pesquisa
        var searchControl = new L.Control.Search({
            layer: pesquisa,
            propertyName: 'nome',
            circleLocation: false,
            marker: false,
            textPlaceholder: "Pesquisa nome logradouro",
            textErr: "Não localizado",
            textCancel: "Cancelar",
            zoom: 18,
            openPopup: false,
            collapsed: true,
            initial: false,
            position: 'topleft',
            minLength: 2
        });
        map.addControl(searchControl);
        //camada não precisa ser visível, apenas para searchcontrol
        map.removeLayer(pesquisa);

        //barra escala
        L.control.scale({ position: "bottomleft", imperial: false }).addTo(map);

        //Norte
        var titulomapa = L.control({ position: 'bottomleft' });

        titulomapa.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info2 legend');
            div.innerHTML +=
                '<center><sub><font size="4">▲</font></sub><br/>' +
                '<sup><font size="2">N</font></sup></center>'
            return div;
        };
        titulomapa.addTo(map);

        //google image
        new L.TileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            opacity: 0.6,
            maxZoom: 20,
            transparent: false,
            attribution: '©2018 Google, SMU/Porto, <a href="mailto:jaceguay@itajai.sc.gov.br?Subject=WebGIS" target="_top">SIE</a>',
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
        }).addTo(map);

        //Mapa base, viário
        var wmsLayer = L.tileLayer.wms('http://geo-smu.itajai.local:8080/geoserver/ows?', {
            layers: 'geoitj:viewsistemaviarioestilosempauta',
            format: 'image/png8',
            opacity: 0.5,
            minZoom: 14,
            maxZoom: 20,
            attribution: false,
            transparent: true
        }).addTo(map);

        //Mapa base, lotes
        var lotcad = L.tileLayer.wms('http://geo-smu.itajai.local:8080/geoserver/ows?', {
            layers: 'geoitj:viewcadastrovias',
            format: 'image/png',
            opacity: 0.3,
            minZoom: 15,
            maxZoom: 20,
            attribution: false,
            transparent: true
        }).addTo(map);

        //Curvas 10x10
        new L.tileLayer.wms('http://geo-smu.itajai.local:8080/geoserver/ows?', {
            layers: 'geoitj:curvas10x10govest2013',
            format: 'image/png8',
            minZoom: 16,
            maxZoom: 20,
            attribution: false,
            transparent: true
        }).addTo(map);

        //Limites Município
        $.getJSON("http://geo-smu.itajai.local:8080/geoserver/geoitj/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=geoitj:geo2007limitesmunicip&outputFormat=application%2Fjson", function (data) {
            L.geoJson(data, {
                style: function (feature) {
                    return {
                        color: '#000000',
                        fill: false
                    };
                },
            }).addTo(map);
        });

        //Paradas mapa>tabela
        //Clustering
        let clustermarcadores = L.markerClusterGroup({ disableClusteringAtZoom: 18 });
        map.addLayer(clustermarcadores);

        //ícone pendência
        let iconagendabus = L.icon({
            iconUrl: 'http://geo-smu.itajai.local/geo/images/pinovermelho.png',
            shadowUrl: 'http://geo-smu.itajai.local/geo/images/pinosombra.png',
            iconSize: [30, 41],
            shadowSize: [20, 13],
            iconAnchor: [26, 40],
            shadowAnchor: [3, 11],
            popupAnchor: [-12, -30]
        });

        let marcadorpnormal = {
            radius: 8,
            fillColor: "#33ff33",
            color: "#000",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8
        };

        //mapa x tabela
        $.ajax({
            type: "GET",
            url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQyHcrT6fAZ_L81AMP-jU4Zsd0HyITl6RuAsntblxi0juoI3rZbq9G0SfYRvw81DBq-xw8zoDwtthta/pub?gid=1002032247&single=true&output=tsv",
            dataType: "text",
            success: (data) => {

                let tabelalinhas = data.split('\n').map(linha => linha.split('\t'));//separa as linhas
                let cabecalho = tabelalinhas.shift();//remove a primeira linha, retorna o cabeçalho
                let tabelaindex = tabelalinhas.reduce((total, numero, indice) => [numero.push(indice)], 0);//adiciona o campo id, gerado feicoes[15]

                //Pontos mapa
                let dadosmapa = new Promise((resolve, reject) => {
                    resolve(
                        $.getJSON("http://10.10.1.158:8080/geoserver/geoitj/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=geoitj:viewptsonibus&maxFeatures=10000000&outputFormat=application%2Fjson")
                    )
                });

                dadosmapa.then((result) => {
                    //console.log(result.features);
                    //console.log(tabelalinhas);
                    L.geoJSON(result, {
                        pointToLayer: (feature, latlng) => {
                            let popuppadrao =
                                '<strong>Código: ' + feature.properties.ident + '</strong>' + '<br/>' +
                                'Modelo: ' + feature.properties.modelo + '<br/>' +
                                'Localização: ' + feature.properties.nomevia + ' altura: ' + feature.properties.altvia + '<br/>' +
                                'Bairro: ' + feature.properties.bairro
                                ;

                            let idmapa = feature.properties.ident;
                            let idtabela = tabelalinhas.filter((item) => { return item[0] == feature.properties.ident; });
                            if (idtabela.length != 0) {
                                return L.marker(latlng, { icon: iconagendabus }).bindPopup(popuppadrao).addTo(map);
                            }
                            else {
                                return L.circleMarker(latlng, marcadorpnormal).bindPopup(popuppadrao).addTo(clustermarcadores);
                            };
                        }
                    });

                    //Tabela map()
                    let objtabela = tabelalinhas.map((feicoes) => {
                        return {
                            'cod': feicoes[0],
                            'dataab': feicoes[1],
                            'descri': feicoes[2],
                            'observ': feicoes[3],
                            'id': feicoes[4]
                        }
                    });

                    //Definir elementos da tabela
                    $("#tabelatabulator").tabulator({
                        height: "25%",
                        layout: "fitColumns",
                        columns: [
                            { title: "Código", field: "cod", width: 80 },
                            { title: "Data abertura do chamado", field: "dataab", width: 210 },
                            { title: "Descrição", field: "descri", width: 350 },
                            { title: "Observações", field: "observ", width: 350 },
                        ],
                        rowClick: function (e, row) { //eventos quando sobre uma linha
                            let poligonodtab = L.geoJSON();
                            let selecao = row.getData();
                            let filtradoobj = result.features.find(e => e.properties.ident == selecao.cod);
                            poligono = L.geoJSON(filtradoobj).addTo(poligonodtab);
                            $("#tabelatabulator").tabulator("deselectRow");
                            map.flyToBounds(poligono.getBounds());
                        },
                    });

                    $("#tabelatabulator").tabulator("setData", objtabela);

                });
            }
        });

    </script>

</body>

</html>