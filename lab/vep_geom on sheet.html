<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title> </title>
    <link rel="icon" type="image/png" href="images/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="images/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="images/favicon-32x32.png" sizes="32x32">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <link rel="stylesheet" href="lib/leaflet.css" />
    <link rel="stylesheet" href="lib/jquery-ui.min.css" />
    <link rel="stylesheet" href="lib/tabulator.min.css" />
</head>

<style>
    body {
        margin: 0;
        padding: 0;
    }

    #map {
        position: absolute;
        top: 0;
        width: 100%;
        height: 70%;
    }

    .leaflet-container {
        background: #ffffff;
    }

    .linhatabela {
        position: absolute;
        bottom: 0;
        width: 99.5%;
        height: 25%;
    }

    .botoestabela {
        position: absolute;
        bottom: 26%;
        background-color: #ffffff;
        z-index: 1000;
    }
</style>

<body>
    <!-- Mapa -->
    <div id="map"></div>
    <!-- Botões de pesquisa -->
    <div class="botoestabela table-controls">
        <span>
            <select id="filter-field">
                <option value="nome">Nome</option>
            </select>
        </span>

        <span>
            <input id="filter-value" type="text" placeholder="digite para filtrar">
        </span>

        <button id="filter-clear">Limpar</button>
    </div>
    <!-- Tabela -->
    <div class="linhatabela" id="tabelatabulator"></div>

    <!-- Bibliotecas -->
    <script src="lib/leaflet.js"></script>
    <script src="lib/jquery-3.3.1.min.js"></script>
    <script src="lib/jquery-ui.min.js"></script>
    <script src="lib/tabulator.min.js"></script>

    <!-- Filtros para a tabela -->
    <script>
        function customFilter(data) {
            return data.car && data.rating < 3;
        };

        //Composição do filtro
        function updateFilter() {

            var filter = $("#filter-field").val() == "function" ? customFilter : $("#filter-field").val();

            if ($("#filter-field").val() == "function") {
                $("#filter-type").prop("disabled", true);
                $("#filter-value").prop("disabled", true);
            } else {
                $("#filter-type").prop("disabled", false);
                $("#filter-value").prop("disabled", false);
            }

            $("#tabelatabulator").tabulator("setFilter", filter, "like", $("#filter-value").val());
        };

        //Atualiza o filtro ao mudar os valores
        $("#filter-field, #filter-type").change(updateFilter);
        $("#filter-value").keyup(updateFilter);

        //Botão reiniciar os valores
        $("#filter-clear").click(function () {
            $("#filter-field").val("nome");
            $("#filter-value").val("");

            $("#tabelatabulator").tabulator("clearFilter");
        });
    </script>

    <!-- Mapa -->
    <script>

        //div do mapa
        var map = new L.Map('map', {
            zoom: 14,
            minZoom: 12,
            maxZoom: 19,
            maxBounds: [
                //south west
                [-27.215341, -49.020370],
                //north east
                [-26.701009, -48.397961]
            ],
            center: new L.latLng([-26.906960, -48.685425])
        });

        //barra escala
        L.control.scale({ position: "bottomright", imperial: false }).addTo(map);

        //Norte
        var north = L.control({ position: "bottomright" });
        north.onAdd = function (map) {
            var div = L.DomUtil.create("div", "info legend");
            div.innerHTML = '<img src="images/setanorte.png">';
            return div;
        }
        north.addTo(map);

        //google image
        new L.TileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            opacity: 0.6,
            maxZoom: 19,
            transparent: false,
            attribution: '©2018 Google, SMU/Porto, <a href="mailto:jaceguay@itajai.sc.gov.br?Subject=WebGIS" target="_top">SIE</a>',
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
        }).addTo(map);

        //mapa, Geometria
        let vepgeom = L.geoJSON().addTo(map);//mapa
        let poligonodtab = L.geoJSON().addTo(map);//destaque seleção a partir da tabela

        let estilopadrao = {
            weight: 1,
            color: 'white',
            dashArray: '',
            fillOpacity: 0.7
        };

        let estilodestaque = {
            weight: 5,
            color: '#666',
            dashArray: '3'
        };

        let destacarfeicao = (e) => {
            vepgeom.setStyle(estilopadrao);
            poligonodtab.clearLayers();
            var layersel = e.target;
            layersel.setStyle(estilodestaque);
            // let rowid = e.sourceTarget.feature.properties.id;
            // $("#tabelatabulator").tabulator("deselectRow");
            // $("#tabelatabulator").tabulator("scrollToRow", rowid, "center", false);
            // $("#tabelatabulator").tabulator("selectRow", rowid);
        };

        $.getJSON("http://10.10.1.158:8080/geoserver/geoitj/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=geoitj:vepderapropria&outputFormat=application%2Fjson", function (data) {
            console.log(data);
            // L.geoJson(data, {
            //     style: estilopadrao,
            //         onEachFeature: (feature, layer) => { layer.on({ click: destacarfeicao }) }
            //     }).addTo(vepgeom);
        });

        //Avaliações
        $.ajax({
            type: "GET",
            url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSJp5cX3QWSFqnFTfZ1UhvE-s7zKxtPI6UG9pucVizvXOqFUqzhEzyGmNRNdVutYJ5aicaI67qhvQCS/pub?gid=1569936527&single=true&output=tsv",
            dataType: "text",
            success: function (data) {

                let tabelalinhas = data.split('\n').map(linha => linha.split('\t'));//separa as linhas
                let cabecalho = tabelalinhas.shift();//remove a primeira linha, retorna o cabeçalho
                //console.log(tabelalinhas);

                //Tabela map()
                let objtabela = tabelalinhas.map((feicoes) => {
                    return {
                        'id': feicoes[0],
                        'nome': feicoes[1],
                        'situacao': feicoes[2],
                    }
                });

                //Tabela
                $("#tabelatabulator").tabulator({
                    height: "25%",
                    layout: "fitColumns",
                    columns: [
                        { title: "N.", field: "nome", width: 40 },
                    ],
                    rowClick: function (e, row) { //eventos quando sobre uma linha
                        vepgeom.setStyle(estilopadrao);
                        poligonodtab.clearLayers();
                        let selecao = row.getIndex();
                        console.log(vepgeom);
                        // poligono = L.geoJSON(vepgeom._layers[78]._layers[77].feature.selecao).addTo(poligonodtab).setStyle(estilodestaque);
                        // $("#tabelatabulator").tabulator("deselectRow");
                        // $("#tabelatabulator").tabulator("selectRow", selecao);
                        // map.flyToBounds(poligono.getBounds());
                    },
                });

                $("#tabelatabulator").tabulator("setData", objtabela);
            }
        });

    </script>

</body>

</html>