<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Planta Cadastral, Itajaí-SC</title>
    <link rel="icon" type="image/png" href="http://geo-smu.itajai.local/geo/images/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="http://geo-smu.itajai.local/geo/images/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="http://geo-smu.itajai.local/geo/images/favicon-32x32.png" sizes="32x32">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <link rel="stylesheet" href="http://geo-smu.itajai.local/geo/lib/leaflet.css" />
    <link rel="stylesheet" href="http://geo-smu.itajai.local/geo/lib/leaflet.draw.css" />
    <link rel="stylesheet" href="http://geo-smu.itajai.local/geo/css/cadastro.css" />
    <link rel="stylesheet" href="http://geo-smu.itajai.local/geo/lib/leaflet-search.min.css" />

    <style>
        .leaflet-control-draw-measure {
            background-image: url(http://geo-smu.itajai.local/geo/images/measure-control.png);
        }

        .leaflet-container .leaflet-control-search {
            left: 1px;
        }

        .leaflet-tooltip {
            font-size: 10px;
            box-shadow: none;
            border: none;
            padding: 1px;
        }
    </style>

</head>

<body>
    <div id="map"></div>
    <script src="http://geo-smu.itajai.local/geo/lib/jquery-3.3.1.min.js"></script>
    <script src="http://geo-smu.itajai.local/geo/lib/leaflet.js"></script>
    <script src="http://geo-smu.itajai.local/geo/lib/leaflet.wms.js"></script>
    <script src="http://geo-smu.itajai.local/geo/lib/leaflet-search.min.js"></script>
    <script src="http://geo-smu.itajai.local/geo/lib/leaflet.tilelayer.fallback.js"></script>
    <script src="http://geo-smu.itajai.local/geo/lib/leaflet.draw.js"></script>
    <script src="http://geo-smu.itajai.local/geo/lib/leaflet.measurecontrol.min.js"></script>
    <script src="http://geo-smu.itajai.local/geo/lib/bundle.js"></script>

    <script>
        //div do mapa
        var map = new L.Map('map', {
            zoom: 14,
            minZoom: 11,
            maxZoom: 20,
            zoomDelta: 0.5,
            zoomSnap: 0.5,
            maxBounds: [
                //south west
                [-27.215341, -49.020370],
                //north east
                [-26.701009, -48.397961]
            ],
            center: new L.latLng([-26.9046, -48.6874]),
            zoomControl: false
        });

        //marca d´água
        L.Control.Watermark = L.Control.extend({
            onAdd: function (map) {
                let img = L.DomUtil.create('img');

                img.src = 'http://geo-smu.itajai.local/geo/images/cadastro.png';
                img.style.width = '250px';

                return img;
            },
            onRemove: function (map) { }
        });

        L.control.watermark = function (opts) {
            return new L.Control.Watermark(opts);
        }
        L.control.watermark({ position: 'topleft' }).addTo(map);

        //Mapa base, google
        //var googleimg = L.layerGroup();
        var googleimg = new L.TileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            opacity: 0.5,
            maxZoom: 20,
            transparent: false,
            attribution: '©2018 Google, Secretaria Municipal da Fazenda - Cadastro, Itajaí-SC,<a href="mailto:jaceguay@itajai.sc.gov.br?Subject=WebGIS" target="_top">SIE</a>',
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
        }).addTo(map);

        //imagem aérea 2013
        var orto2013 = L.layerGroup();
        //agritec1
        L.tileLayer.fallback('http://geo-smu.itajai.local/geo/ortoimagens/aeromapas2013/{z}/{x}/{y}.png', {
            opacity: 0.5,
            minZoom: 10,
            maxZoom: 20,
            attribution: 'Secretaria Municipal da Fazenda - Cadastro, Itajaí-SC,<a href="mailto:jaceguay@itajai.sc.gov.br?Subject=WebGIS" target="_top">SIE</a>'
        }).addTo(orto2013);

        //Mapa 1984, restituição
        var agritec1984 = L.layerGroup();
        //agritec1
        L.tileLayer.fallback('http://geo-smu.itajai.local/geo/ortoimagens/agritec1984/1/{z}/{x}/{y}.png', {
            minZoom: 10,
            maxZoom: 20
        }).addTo(agritec1984);

        //agritec2
        L.tileLayer.fallback('http://geo-smu.itajai.local/geo/ortoimagens/agritec1984/2/{z}/{x}/{y}.png', {
            minZoom: 10,
            maxZoom: 20
        }).addTo(agritec1984);

        //agritec3
        L.tileLayer.fallback('http://geo-smu.itajai.local/geo/ortoimagens/agritec1984/3/{z}/{x}/{y}.png', {
            minZoom: 10,
            maxZoom: 20
        }).addTo(agritec1984);

        //Aeroimagem 2007
        var aeroimagem2007 = L.tileLayer.fallback('http://geo-smu.itajai.local/geo/ortoimagens/aeroimagem2007/{z}/{x}/{y}.png', {
            minZoom: 10,
            maxZoom: 20
        });

        //IGBE 1981
        var ibge1981 = L.tileLayer.fallback('http://geo-smu.itajai.local/geo/ortoimagens/ibge1981/{z}/{x}/{y}.png', {
            minZoom: 10,
            maxZoom: 20
        });

        //barra escala
        L.control.scale({ imperial: false }).addTo(map);

        //Mapa base, viário
        new L.tileLayer.wms('http://10.10.1.158:8080/geoserver/ows?', {
            layers: 'geoitj:curvas10x10govest2013',
            format: 'image/png8',
            minZoom: 16,
            maxZoom: 20,
            attribution: false,
            transparent: true
        }).addTo(map);

        //Limites Município
        $.getJSON("http://geo-smu.itajai.local/geo/data/limitesmunicipais.geojson", function (data) {
            L.geoJson(data, {
                style: function (feature) {
                    return {
                        color: '#000000',
                        fill: false
                    };
                },
            }).addTo(map);
        });

        //Cadastro
        var CleanInfoSource = L.WMS.Source.extend({
            'showFeatureInfo': function (latlng, info) {
                if (!this._map) { return };
                //let nome = info.split(/\n|=/);
                //console.log(nome);
                let nadaencontrado = info.split(/\n|=/)[0];
                let vianomechk = info.split(/\n|=/)[16];
                let vianome = info.split(/\n|=/)[17];
                let vialeichk = info.split(/\n|=/)[14];
                let vialei = info.split(/\n|=/)[15];
                let viaptotalchk = info.split(/\n|=/)[8];
                let viaptotal = info.split(/\n|=/)[9];
                let passeioa = info.split(/\n|=/)[11];
                let passeiob = info.split(/\n|=/)[13];
                let loteinscrchk = info.split(/\n|=/)[6];
                let loteinscr = info.split(/\n|=/)[7];
                //let lotequadracrchk = info.split(/\n|=/)[8];
                //let lotequadra = info.split(/\n|=/)[9];
                let lotenumchk = info.split(/\n|=/)[12];
                let lotenum = info.split(/\n|=/)[13];
                //let loteviachk = info.split(/\n|=/)[12];
                let lotevia = info.split(/\n|=/)[17];
                let lotefacechk = info.split(/\n|=/)[10];
                let loteface = info.split(/\n|=/)[11];
                let lotedatachk = info.split(/\n|=/)[14];
                let lotedata = info.split(/\n|=/)[15];
                //campos
                let legendaA;
                let legendaB;
                let legendaC;
                //abastecer os campos'';
                if (nadaencontrado == 'no features were found') {
                    legendaA = 'clique sobre um elemento';
                    legendaB = '';
                    legendaC = '';
                    legendaD = '';
                };
                //legenda sistema viário
                if (vianomechk == 'nome ') { legendaA = '<strong>' + vianome + '</strong>' };
                if (vialeichk == 'leidata ') { legendaB = 'Lei' + vialei };
                if (viaptotalchk == 'ptotalvia ') {
                    legendaC = 'Cx.da via: ' + viaptotal + 'm';
                    legendaD = 'Passeios:' + passeioa + '/' + passeiob + 'm';
                };
                //legenda lote
                if (loteinscrchk == 'inscr ') { legendaA = 'Inscr.Imob.: ' + '<strong>' + loteinscr + '</strong>' };
                if (lotenumchk == 'numero ' && lotevia == ' ') { legendaB = 'Número: ' + lotenum };
                if (lotenumchk == 'numero ' && lotevia != ' ') { legendaB = 'End: ' + lotevia + ', nº: ' + lotenum };
                if (lotefacechk == 'face ') { legendaC = 'Face: ' + loteface };
                if (lotedatachk == 'data ' && lotedata == ' null') { legendaD = 'Conferência pendente' };
                if (lotedatachk == 'data ' && lotedata != ' null') { legendaD = 'Atualizado: ' + lotedata };
                //legenda
                info = legendaA + '<br/>' + legendaB + '<br/>' + legendaC + '<br/>' + legendaD;
                //popup
                this._map.openPopup(info, latlng);
            }
        });
        var options = { 'transparent': true, 'info_format': 'text/plain', 'format': 'image/png8', 'tiled': true, minZoom: 10, maxZoom: 20, opacity: 0.7 };
        var source = new CleanInfoSource("http://geo-smu.itajai.local:8080/geoserver/geoitj/wms", options);
        source.addSubLayer('geoitj:viewsistemaviarioestilosempauta');
        source.addSubLayer('geoitj:viewcadastrovias');
        source.addTo(map);

        //perímetro urbano
        $.getJSON("http://geo-smu.itajai.local:8080/geoserver/geoitj/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=geoitj:perimetrourbano79&outputFormat=application%2Fjson", function (data) {
            L.geoJson(data, {
                style: function (feature) {
                    return { color: "#ff0000", dashArray: "10 10", Opacity: 0.8 };
                },
                onEachFeature: function (feature, layer) {
                    layer.bindPopup(
                        'Perímetro urbano, leis 1764/79 e 4157/04'
                    );
                }
            }).addTo(map);
        });

        //Controle de camadas
        var overlay2 = {};
        var baseMaps = {
            "Ortofoto, ano 2013": orto2013,
            "Imagem, Google maps": googleimg,
            "Agritec 1984": agritec1984,
            "Aeroimagem 2007": aeroimagem2007,
            "IBGE 1981": ibge1981
        };
        L.control.layers(baseMaps, null, { collapsed: false, position: 'bottomleft' }).addTo(map);

        //Botão zoom posicionado
        L.control.zoom({
            position: 'bottomleft'
        }).addTo(map);

        //Sistema viário para pesquisa
        var pesquisa = new L.LayerGroup();
        $.getJSON("http://geo-smu.itajai.local:8080/geoserver/geoitj/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=geoitj:viewsistemaviariopts&outputFormat=application%2Fjson", function (data) { L.geoJson(data).addTo(pesquisa) });

        //Barra pesquisa
        var searchControl = new L.Control.Search({
            layer: pesquisa,
            propertyName: 'nome',
            circleLocation: false,
            marker: false,
            textPlaceholder: "Pesquisa nome logradouro",
            textErr: "Não localizado",
            textCancel: "Cancelar",
            zoom: 18,
            openPopup: false,
            collapsed: true,
            initial: false,
            position: 'bottomleft',
            minLength: 2
        });
        map.addControl(searchControl);
        //camada não precisa ser visível, apenas para searchcontrol
        map.removeLayer(pesquisa);

        //pesquisa por setor.quadra
        var pesquisaQ = L.featureGroup().addTo(map);
        function elementoNavQ() {
            let inputpesquisaQ = document.forms["pesquisaquadra"]["setorQuadra"].value;
            pesquisaQ.clearLayers();
            $.getJSON("http://geo-smu.itajai.local:8080/geoserver/wfs?service=wfs&version=1.0.0&request=getfeature&typename=geoitj:viewcadastrovias&outputFormat=application%2Fjson&CQL_FILTER=(inscr='" + inputpesquisaQ + "')OR(quadra='" + inputpesquisaQ + "')",
                function (data) {
                    let error = data.totalFeatures;
                    if (error == 0) {
                        alert('não encontrado');
                    }
                    else {
                        L.geoJson(data, {
                            style: function (feature) {
                                return { color: '#000000', fillColor: "#ffffff", fillOpacity: 0.5, weight: 5 }
                            },
                            onEachFeature: function (feature, layer) {
                                layer.bindTooltip(
                                    'L:' + feature.properties.lote + '</br>' + 'Nº:' + feature.properties.numero, { permanent: true, direction: "center" }
                                );
                            }
                        }).addTo(pesquisaQ);
                        let dataq = pesquisaQ.getBounds();
                        map.flyToBounds(dataq);
                    };
                });
        };

        //caixa de pesquisa
        var InfoControl = L.Control.extend({
            options: { position: "topleft" },

            onAdd: function (map) {
                this._div = L.DomUtil.create('div', 'info');
                L.DomEvent.disableClickPropagation(this._div);
                this.update();
                return this._div;
            },
            update: function (d) {
                this._div.innerHTML =
                    '<form name="pesquisaquadra" action="" onsubmit="elementoNavQ(); return false;" method="post">' +
                    '<input type="submit" value="Pesquisar setor.quadra e ou .lote">' + '</br>' +
                    '<input type="text" placeholder="Ex.:202.015 ou 202.015.0685" name="setorQuadra">' +
                    '</form>';
            }
        });
        var info = new InfoControl().addTo(map);

        //botão impressão
        L.easyPrint({
            title: 'Imprimir mapa',
            position: 'bottomleft',
            hideControlContainer: false,
            customWindowTitle: 'Planta Cadastral',
            defaultSizeTitles: { Current: 'Tela', A4Landscape: 'A4 Paisagem', A4Portrait: 'A4 Retrato' },
            sizeModes: ['A4Portrait', 'A4Landscape']
        }).addTo(map);

        //#Conflitos#
        var conflitos = new L.LayerGroup();
        var sauicon = L.icon({
            iconUrl: 'http://geo-smu.itajai.local/geo/images/dotamarelo.png',
            iconAnchor: [12, 12],
            popupAnchor: [0, -12],
            iconSize: [25, 25]
        });

        $.getJSON("http://10.10.1.158:8080/geoserver/geoitj/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=geoitj:viewcadastrolotesconflito&outputFormat=application%2Fjson", function (data) {
            L.geoJson(data, {
                pointToLayer: function (feature, latlng) {
                    var marker = L.marker(latlng, { icon: sauicon });
                    marker.bindPopup(
                        'Inscr.Imob.: <strong>' + feature.properties.inscr + '</strong><br/>' +
                        'End.: ' + feature.properties.nomevia + ', ' + feature.properties.numero + '<br/>' +
                        'Face: ' + feature.properties.face + '<br/>' +
                        'Atualizado: ' + feature.properties.data
                    );
                    return marker;
                }
            }).addTo(conflitos);
        });

        //remover camada propostas no zoom máximo
        map.on('zoomend', function () {
            if (map.getZoom() < 18) {
                map.removeLayer(conflitos);
            }
            else {
                map.addLayer(conflitos);
            }
        });

        //Ferramenta medidas
        L.Control.measureControl({ position: 'bottomleft' }).addTo(map);

    </script>
</body>

</html>