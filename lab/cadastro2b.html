<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title> </title>
    <link rel="icon" type="image/png" href="http://geo-smu.itajai.local/geo/images/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="http://geo-smu.itajai.local/geo/images/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="http://geo-smu.itajai.local/geo/images/favicon-32x32.png" sizes="32x32">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <link rel="stylesheet" href="http://geo-smu.itajai.local/geo/lib/leaflet.css" />
    <link rel="stylesheet" href="http://geo-smu.itajai.local/geo/lib/jquery-ui.min.css" />
    <link rel="stylesheet" href="http://geo-smu.itajai.local/geo/lib/tabulator.min.css" />
</head>

<style>
    body {
        margin: 0;
        padding: 0;
    }

    #map {
        position: absolute;
        top: 0;
        width: 100%;
        height: 75%;
    }

    .leaflet-container {
        background: #ffffff;
    }

    .linhatabela {
        position: absolute;
        bottom: 0;
        width: 99.5%;
        height: 25%;
    }
</style>

<body>
    <!-- Mapa -->
    <div id="map"></div>

    <!-- Tabela -->
    <div class="linhatabela" id="tabelatabulator"></div>

    <!-- Bibliotecas -->
    <script src="http://geo-smu.itajai.local/geo/lib/leaflet.js"></script>
    <script src="http://geo-smu.itajai.local/geo/lib/jquery-3.3.1.min.js"></script>
    <script src="http://geo-smu.itajai.local/geo/lib/jquery-ui.min.js"></script>
    <script src="http://geo-smu.itajai.local/geo/lib/tabulator.min.js"></script>
    <script src="http://geo-smu.itajai.local/geo/lib/leaflet.wms.js"></script>
    <script src="http://geo-smu.itajai.local/geo/lib/papaparse.min.js"></script>

    <!-- Mapa -->
    <script>

        //div do mapa
        var map = new L.Map('map', {
            zoom: 14,
            minZoom: 12,
            maxZoom: 20,
            maxBounds: [
                //south west
                [-27.215341, -49.020370],
                //north east
                [-26.701009, -48.397961]
            ],
            center: new L.latLng([-26.906960, -48.685425]),
            zoomControl: false
        });

        //marca d´água
        L.Control.Watermark = L.Control.extend({
            onAdd: function (map) {
                let img = L.DomUtil.create('img');

                img.src = 'http://geo-smu.itajai.local/geo/images/cadastro2.png';
                img.style.width = '250px';

                return img;
            },
            onRemove: function (map) { }
        });

        L.control.watermark = function (opts) {
            return new L.Control.Watermark(opts);
        }
        L.control.watermark({ position: 'topleft' }).addTo(map);

        //barra escala
        L.control.scale({ position: "bottomright", imperial: false }).addTo(map);

        //Botão zoom posicionado
        L.control.zoom({ position: 'topright' }).addTo(map);

        //google image
        new L.TileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            opacity: 0.6,
            maxZoom: 20,
            transparent: false,
            attribution: '©2018 Google, SMU/Porto, <a href="mailto:jaceguay@itajai.sc.gov.br?Subject=WebGIS" target="_top">SIE</a>',
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
        }).addTo(map);

        //Curvas 10x10
        new L.tileLayer.wms('http://10.10.1.158:8080/geoserver/ows?', {
            layers: 'geoitj:curvas10x10govest2013',
            format: 'image/png8',
            minZoom: 16,
            maxZoom: 20,
            attribution: false,
            transparent: true
        }).addTo(map);

        //Limites Município
        $.getJSON("http://geo-smu.itajai.local:8080/geoserver/geoitj/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=geoitj:geo2007limitesmunicip&outputFormat=application%2Fjson", function (data) {
            L.geoJson(data, {
                style: function (feature) {
                    return {
                        color: '#000000',
                        fill: false
                    };
                },
            }).addTo(map);
        });

        //Cadastro
        //Definir elementos da tabela
        $("#tabelatabulator").tabulator({
            height: "25%",
            layout: "fitColumns",
            columns: [
                { title: "Código", field: "codigo", width: 80 },
                { title: "Inscrição", field: "inscricao", width: 160 },
                { title: "Matrícula", field: "matricula", width: 100 },
                { title: "Nome", field: "nome", width: 350 },
                { title: "Logradouro(TMI)", field: "logradouro", width: 150 },
                { title: "nº", field: "numeroimov", width: 50 },
                { title: "Complemento", field: "compleme_1", width: 120 },
                { title: "Bairro", field: "bairro", width: 150 },
                { title: "Patrimônio", field: "patrimonio", width: 120 },
                { title: "Benfeitoria", field: "benfeitori", width: 120 },
                { title: "Área(TMI)", field: "area", width: 120 },
                { title: "Test.", field: "testadapri", width: 90 },
                { title: "Prof.", field: "profundida", width: 90 },
                { title: "Passeio", field: "passeio", width: 90 },
                { title: "Disposição lote", field: "dispnolote", width: 120 },
                { title: "Situação lote", field: "situacaolo", width: 120 },
                { title: "Topografia", field: "topografia", width: 120 },
                { title: "Utilização", field: "utilizacao", width: 120 },
                { title: "Nº pavtos.", field: "numpavimen", width: 100 },
                { title: "Situação edif.", field: "situacaoed", width: 120 },
                { title: "Espécie", field: "especie", width: 120 },
                { title: "Conservação", field: "conservaca", width: 120 },
                { title: "Imóvel Rural", field: "imovrural", width: 120 },
                { title: "Nº INCRA", field: "incra", width: 120 },
                { title: "Nº Medidor de energia", field: "nenergia", width: 120 },
                { title: "Nº Hidrômetro", field: "nhidrometr", width: 120 },
            ]
        });

        //WMS
        var CleanInfoSource = L.WMS.Source.extend({
            'showFeatureInfo': function (latlng, info) {
                if (!this._map) { return };
                //console.log(info.split(/\n|=/));

                //async para a tabela
                let promise = new Promise(function (resolve, reject) {
                    resolve(info.split(/\n|=/)[7].trim());
                });
                promise.then(function (result) {
                    Papa.parse("http://geo-smu.itajai.local:8080/geoserver/geoitj/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=geoitj:tmi&outputFormat=csv&CQL_FILTER=inscrlig='" + result + "'", {
                        download: true,
                        header: true,
                        skipEmptyLines: true,
                        complete: function (results) {
                            //popular a tabela com os resultados
                            $("#tabelatabulator").tabulator("setData", results.data);
                        }
                    });
                });

                //legenda - ANTIGA
                let nadaencontrado = info.split(/\n|=/)[0];
                let vianomechk = info.split(/\n|=/)[16];
                let vianome = info.split(/\n|=/)[17];
                let vialeichk = info.split(/\n|=/)[14];
                let vialei = info.split(/\n|=/)[15];
                let viaptotalchk = info.split(/\n|=/)[8];
                let viaptotal = info.split(/\n|=/)[9];
                let passeioa = info.split(/\n|=/)[11];
                let passeiob = info.split(/\n|=/)[13];
                let lotenumchk = info.split(/\n|=/)[10];
                let lotenum = info.split(/\n|=/)[11];
                let loteviachk = info.split(/\n|=/)[8];
                let lotevia = info.split(/\n|=/)[9];
                let lotedatachk = info.split(/\n|=/)[12];
                let lotedata = info.split(/\n|=/)[13];
                //campos
                let legendaA;
                let legendaB;
                let legendaC;
                //abastecer os campos'';
                if (nadaencontrado == 'no features were found') {
                    legendaA = 'clique sobre um elemento';
                    legendaB = '';
                    legendaC = '';
                };
                //legenda sistema viário
                if (vianomechk == 'nome ') { legendaA = '<strong>' + vianome + '</strong>' };
                if (vialeichk == 'leidata ') { legendaB = 'Lei' + vialei };
                if (viaptotalchk == 'ptotalvia ') {
                    legendaC = 'Cx.da via: ' + viaptotal + 'm' + ' - Passeios:' + passeioa + '/' + passeiob + 'm';
                };
                //legenda lote
                if (loteviachk == 'nomevia ') { legendaA = '' };
                if (lotenumchk == 'numero ' && lotevia == ' ') { legendaB = 'Número: ' + lotenum };
                if (lotenumchk == 'numero ' && lotevia != ' ') { legendaB = 'End: ' + lotevia + ', nº: ' + lotenum };
                if (lotedatachk == 'datamod ' && lotedata == ' null') { legendaC = 'Conferência pendente' };
                if (lotedatachk == 'datamod ' && lotedata != ' null') { legendaC = 'Planta atualizada: ' + lotedata };
                //legenda
                info = legendaA + '<br/>' + legendaB + '<br/>' + legendaC;
                //popup
                this._map.openPopup(info, latlng);
            }
        });
        var options = { 'transparent': true, 'info_format': 'text/plain', 'format': 'image/png8', 'tiled': true, minZoom: 10, maxZoom: 20, opacity: 0.7 };
        var source = new CleanInfoSource("http://geo-smu.itajai.local:8080/geoserver/geoitj/wms", options);
        source.addSubLayer('geoitj:viewsistemaviarioestilosempauta');
        source.addSubLayer('geoitj:plantalig');
        source.addTo(map);

        //pesquisa por setor.quadra
        var pesquisaQ = L.featureGroup().addTo(map);
        function elementoNavQ() {
            let inputpesquisaQ = document.forms["pesquisaquadra"]["setorQuadra"].value;
            pesquisaQ.clearLayers();
            $.getJSON("http://geo-smu.itajai.local:8080/geoserver/wfs?service=wfs&version=1.0.0&request=getfeature&typename=geoitj:tmigeom&outputFormat=application%2Fjson&CQL_FILTER=codigo='" + inputpesquisaQ + "'",
                function (data) {
                    let error = data.totalFeatures;
                    if (error == 0) {
                        alert('não encontrado');
                    }
                    else {
                        L.geoJson(data, {
                            style: function (feature) {
                                return { color: '#000000', fillColor: "#ffffff", fillOpacity: 0.5, weight: 5 }
                            }
                        }).addTo(pesquisaQ);
                        let dataq = pesquisaQ.getBounds();
                        map.flyToBounds(dataq);
                        //async para a tabela
                        let promise = new Promise(function (resolve, reject) {
                            resolve(data.features["0"].properties.inscrlig);
                        });
                        promise.then(function (result) {
                            Papa.parse("http://geo-smu.itajai.local:8080/geoserver/geoitj/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=geoitj:tmi&outputFormat=csv&CQL_FILTER=inscrlig='" + result + "'", {
                                download: true,
                                header: true,
                                skipEmptyLines: true,
                                complete: function (results) {
                                    //popular a tabela com os resultados
                                    $("#tabelatabulator").tabulator("setData", results.data);
                                }
                            });
                        });
                    };
                });
        };

        //caixa de pesquisa
        var InfoControl = L.Control.extend({
            options: { position: "topleft" },

            onAdd: function (map) {
                this._div = L.DomUtil.create('div', 'info');
                L.DomEvent.disableClickPropagation(this._div);
                this.update();
                return this._div;
            },
            update: function (d) {
                this._div.innerHTML =
                    '<form name="pesquisaquadra" action="" onsubmit="elementoNavQ(); return false;" method="post">' +
                    '<input type="submit" value="Pesquisa por cód.cadastro">' + '</br>' +
                    '<input type="text" placeholder="000000000" name="setorQuadra">' +
                    '</form>';
            }
        });
        var info = new InfoControl().addTo(map);

    </script>

</body>

</html>