<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title> </title>
    <link rel="icon" type="image/png" href="http://geo-smu.itajai.local/geo/images/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="http://geo-smu.itajai.local/geo/images/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="http://geo-smu.itajai.local/geo/images/favicon-32x32.png" sizes="32x32">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <link rel="stylesheet" href="http://geo-smu.itajai.local/geo/lib/leaflet.css" />
    <link rel="stylesheet" href="http://geo-smu.itajai.local/geo/lib/jquery-ui.min.css" />
    <link rel="stylesheet" href="http://geo-smu.itajai.local/geo/lib/tabulator.min.css" />
    <link rel="stylesheet" href="http://geo-smu.itajai.local/geo/lib/leaflet.draw.css" />
    <link rel="stylesheet" href="http://geo-smu.itajai.local/geo/lib/leaflet-search.min.css" />
</head>

<style>
    body {
        margin: 0;
        padding: 0;
    }

    #map {
        position: absolute;
        top: 0;
        width: 100%;
        height: 70%;
    }

    .leaflet-container {
        background: #ffffff;
    }

    .linhatabela {
        position: absolute;
        bottom: 0;
        width: 99.5%;
        height: 25%;
    }

    .botoestabela {
        position: absolute;
        bottom: 26%;
        background-color: #ffffff;
        z-index: 1000;
    }

    .leaflet-tooltip {
        background: transparent;
        color: black;
        border: none;
        box-shadow: none;
        text-shadow: -1px 0 white, 0 1px white, 1px 0 white, 0 -1px white;
    }

    .dot {
        height: 20px;
        width: 20px;
        text-align: center;
        vertical-align: middle;
        border-radius: 50%;
        display: inline-block;
    }

    .info {
        padding: 6px 8px;
        font: 14px/16px Arial, Helvetica, sans-serif;
        background: white;
        background: rgba(255, 255, 255, 0.8);
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
    }

    .info h4 {
        margin: 0 0 5px;
        color: #777;
    }
</style>

<body>
    <!-- Mapa -->
    <div id="map"></div>
    <!-- Botões de pesquisa -->
    <div class="botoestabela table-controls">
        <span>
            <select id="filter-field">
                <option value="imovel">Imóvel</option>
                <option value="situacao">Situação</option>
            </select>
        </span>

        <span>
            <input id="filter-value" type="text" placeholder="digite para filtrar">
        </span>

        <button id="filter-clear">Limpar</button>
    </div>
    <!-- Tabela -->
    <div class="linhatabela" id="tabelatabulator"></div>

    <!-- Bibliotecas -->
    <script src="http://geo-smu.itajai.local/geo/lib/leaflet.js"></script>
    <script src="http://geo-smu.itajai.local/geo/lib/jquery-3.3.1.min.js"></script>
    <script src="http://geo-smu.itajai.local/geo/lib/jquery-ui.min.js"></script>
    <script src="http://geo-smu.itajai.local/geo/lib/tabulator.min.js"></script>
    <script src="http://geo-smu.itajai.local/geo/lib/leaflet.draw.js"></script>
    <script src="http://geo-smu.itajai.local/geo/lib/leaflet.measurecontrol.min.js"></script>
    <script src="http://geo-smu.itajai.local/geo/lib/leaflet-search.min.js"></script>

    <!-- Filtros para a tabela -->
    <script>
        function customFilter(data) {
            return data.car && data.rating < 3;
        };

        //Composição do filtro
        function updateFilter() {

            var filter = $("#filter-field").val() == "function" ? customFilter : $("#filter-field").val();

            if ($("#filter-field").val() == "function") {
                $("#filter-type").prop("disabled", true);
                $("#filter-value").prop("disabled", true);
            } else {
                $("#filter-type").prop("disabled", false);
                $("#filter-value").prop("disabled", false);
            }

            $("#tabelatabulator").tabulator("setFilter", filter, "like", $("#filter-value").val());
        };

        //Atualiza o filtro ao mudar os valores
        $("#filter-field, #filter-type").change(updateFilter);
        $("#filter-value").keyup(updateFilter);

        //Botão reiniciar os valores
        $("#filter-clear").click(function () {
            $("#filter-field").val("imovel");
            $("#filter-value").val("");

            $("#tabelatabulator").tabulator("clearFilter");
        });
    </script>

    <!-- Mapa -->
    <script>

        //div do mapa
        var map = new L.Map('map', {
            zoom: 15,
            minZoom: 12,
            maxZoom: 19,
            maxBounds: [
                //south west
                [-27.215341, -49.020370],
                //north east
                [-26.701009, -48.397961]
            ],
            center: new L.latLng([-26.8968, -48.6884]),
            zoomControl: false
        });

        //título
        var titulomapa = L.control({ position: 'topleft' });

        titulomapa.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info legend');
            div.innerHTML +=
                '<strong><font size="4">VIA EXPRESSA PORTUÁRIA</font></strong><br/>' +
                '<font size="2">Situação dos lotes 1º etapa</font><br/>'
            return div;
        };
        titulomapa.addTo(map);

        //Botão zoom posicionado
        L.control.zoom({ position: 'topleft' }).addTo(map);

        //barra escala
        L.control.scale({ position: "topright", imperial: false }).addTo(map);

        //Norte
        var north = L.control({ position: "topright" });
        north.onAdd = function (map) {
            var div = L.DomUtil.create("div", "info legend");
            div.innerHTML = '<img src="http://geo-smu.itajai.local/geo/images/setanorte.png">';
            return div;
        }
        north.addTo(map);

        //google image
        new L.TileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            opacity: 0.6,
            maxZoom: 19,
            transparent: false,
            attribution: '©2018 Google, SMU/Porto, <a href="mailto:jaceguay@itajai.sc.gov.br?Subject=WebGIS" target="_top">SIE</a>',
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
        }).addTo(map);

        //Mapa base, viário
        var wmsLayer = L.tileLayer.wms('http://10.10.1.158:8080/geoserver/ows?', {
            layers: 'geoitj:viewsistemaviarioestilosempauta',
            format: 'image/png8',
            opacity: 0.3,
            minZoom: 15,
            maxZoom: 20,
            attribution: false,
            transparent: true
        }).addTo(map);

        //VEP lotes
        $.ajax({
            type: "GET",
            url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSJp5cX3QWSFqnFTfZ1UhvE-s7zKxtPI6UG9pucVizvXOqFUqzhEzyGmNRNdVutYJ5aicaI67qhvQCS/pub?gid=361951078&single=true&output=tsv",
            dataType: "text",
            success: function (data) {

                //mapa, Geometria
                let vepgeom = L.geoJSON().addTo(map);//mapa
                let poligonodtab = L.geoJSON().addTo(map);//destaque seleção a partir da tabela

                let tabelalinhas = data.split('\n').map(linha => linha.split('\t'));//separa as linhas
                let cabecalho = tabelalinhas.shift();//remove a primeira linha, retorna o cabeçalho
                let tabelaindex = tabelalinhas.reduce((total, numero, indice) => [numero.push(indice)], 0);//adiciona o campo id, gerado feicoes[15]
                //console.log(tabelalinhas);

                //Tabela
                let objtabela = tabelalinhas.map((feicoes) => {
                    return {
                        'id': feicoes[0],
                        'imovel': feicoes[1],
                        'status': feicoes[2],
                        'historiaatual': feicoes[3],
                        'cdvep': feicoes[4],
                        'processdesap': feicoes[5],
                        'interessada': feicoes[6],
                        'interessadaatual': feicoes[7],
                        'fone': feicoes[8],
                        'datadecreto': feicoes[9],
                        'vencdecreto': feicoes[10],
                        'validecreto': feicoes[11],
                        'nuntituloa': feicoes[12],
                        'datadocimov': feicoes[13],
                        'vencmatricula': feicoes[14],
                        'validadematric': feicoes[15],
                        'datapedidomatric': feicoes[16],
                        'dataretiradamatric': feicoes[17],
                        'interessada': feicoes[18],
                        'tituloaquisit': feicoes[19],
                        'inventario': feicoes[20],
                        'onus': feicoes[21],
                        'propriedade': feicoes[22],
                        'pastaproc': feicoes[23],
                        'assentamento': feicoes[24],
                        'casaterreno': feicoes[25],
                        'aluguelsocial': feicoes[26],
                        'amigaveljudicial': feicoes[27],
                        'reuniaocomdesaprop': feicoes[28],
                        'obsgeral': feicoes[29],
                        'interessada2': feicoes[30],
                        'datasituacao': feicoes[31],
                        'situacao': feicoes[32],
                        'situacaooque': feicoes[33],
                        'situacaoobs': feicoes[34],
                        'responacao': feicoes[35],
                        'acao': feicoes[36],
                        'acaobos': feicoes[37],
                        'interessada3': feicoes[38],
                        'valomaxind': feicoes[39],
                        'fonte': feicoes[40],
                        'pagamento': feicoes[41],
                        'data2parc': feicoes[42],
                        'valorpagocontrapart': feicoes[43],
                        'saldocontrapart': feicoes[44],
                        'quantdecasos': feicoes[45],
                    }
                });

                //carrega geojson
                $.getJSON("http://10.10.1.158:8080/geoserver/geoitj/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=geoitj:vepderapropria&outputFormat=application%2Fjson", function (data) {

                    let geos = data.features;
                    let geomuniao = geos.map((feicoes) => {
                        let nometab = objtabela.nome;
                        return {
                            'type': 'Feature',
                            'properties': {
                                'id': feicoes.properties.id
                            },
                            'geometry': {
                                'type': 'MultiPolygon',
                                'coordinates': feicoes.geometry.coordinates
                            }
                        }
                    });

                    let estilopadrao = (feature) => {
                        return {
                            weight: 1,
                            color: '#f2f2f2',
                            dashArray: null
                        };
                    }

                    let estilodestaque = {
                        weight: 5,
                        dashArray: '6',
                        color: 'black'
                    };

                    let destacarfeicao = (e) => {
                        vepgeom.setStyle(estilopadrao);
                        poligonodtab.clearLayers();
                        var layersel = e.target;
                        layersel.setStyle(estilodestaque);
                        let rowid = e.sourceTarget.feature.properties.id;
                        $("#tabelatabulator").tabulator("deselectRow");
                        $("#tabelatabulator").tabulator("scrollToRow", rowid, "center", false);
                        $("#tabelatabulator").tabulator("selectRow", rowid);
                    };

                    //mapa
                    console.log(objtabela["0"].id);
                    L.geoJson(geomuniao, {
                        style: (feature, layer) => {
                            let corzona;
                            console.log(feature.properties.id);
                            let cormz = objtabela[feature.properties.id.toString()].situacao;
                            console.log(cormz);
                            // if (cormz.includes("Concluso vep anterior")) feature.properties.situacao = "#00cc66";
                            // if (cormz.includes("Concluso vep atual")) feature.properties.situacao = "#00ffff";
                            // if (cormz.includes("Concluso vep fazer prestacao de contas")) feature.properties.situacao = "#0000ff";
                            // if (cormz.includes("Indenização dispensada")) feature.properties.situacao = "#ff99ff";
                            // if (cormz.includes("Paralisada")) feature.properties.situacao = "#f1e2cc";
                            // if (cormz.includes("PENDENTE")) feature.properties.situacao = "#ffff00";
                            // if (cormz.includes("Resolvido")) feature.properties.situacao = "#ffffff";
                            return { weight: 1, color: '#f2f2f2', fillColor: '#ffffff', fillOpacity: 0.4, weight: 2 };
                        },
                        onEachFeature: (feature, layer) => {
                            layer.on({ click: destacarfeicao });
                            //layer.bindTooltip(feature.properties.nome, { sticky: true, direction: 'center' });
                        }
                    }).addTo(vepgeom);

                    //tabela
                    $("#tabelatabulator").tabulator({
                        height: "25%",
                        layout: "fitColumns",
                        columns: [
                            { title: "id", field: "id", width: 40 },
                            { title: "Imóvel", field: "imovel", width: 80 },
                            { title: "Status", field: "status", width: 100 },
                            { title: "História/Atual", field: "historiaatual", width: 100 },
                            { title: "CDVEP", field: "cdvep", width: 80 },
                            { title: "Processo desaprop.", field: "processdesap", width: 120 },
                            { title: "Interessada", field: "interessada", width: 200 },
                            { title: "Interessada atual", field: "interessadaatual", width: 250 },
                            { title: "Fone", field: "fone", width: 100 },
                            { title: "Data decreto", field: "datadecreto", width: 100 },
                            { title: "Venc.decreto", field: "vencdecreto", width: 100 },
                            { title: "Validade decreto", field: "validecreto", width: 100 },
                            { title: "Nº título aquisitivo", field: "nuntituloa", width: 100 },
                            { title: "Data doc.imóvel", field: "datadocimov", width: 100 },
                            { title: "Venc.matrícula", field: "vencmatricula", width: 100 },
                            { title: "Validade matrícula", field: "validadematric", width: 100 },
                            { title: "Data pedido matrícula", field: "datapedidomatric", width: 100 },
                            { title: "Data retirada matrícula", field: "dataretiradamatric", width: 100 },
                            { title: "Interessada", field: "interessada", width: 200 },
                            { title: "Título aquisitivo", field: "tituloaquisit", width: 100 },
                            { title: "Inventário", field: "inventario", width: 100 },
                            { title: "Ônus", field: "onus", width: 100 },
                            { title: "Propriedade", field: "propriedade", width: 250 },
                            { title: "Pasta processo", field: "pastaproc", width: 100 },
                            { title: "Assentamento", field: "assentamento", width: 100 },
                            { title: "Casa/terreno", field: "casaterreno", width: 100 },
                            { title: "Aluguel social", field: "aluguelsocial", width: 100 },
                            { title: "Amigável/judicial", field: "amigaveljudicial", width: 100 },
                            { title: "Reunião com desaprop.", field: "reuniaocomdesaprop", width: 100 },
                            { title: "Obs.geral", field: "obsgeral", width: 100 },
                            { title: "Interessada", field: "interessada2", width: 100 },
                            { title: "Data situação", field: "datasituacao", width: 100 },
                            { title: "Situação, como está", field: "situacao", width: 100 },
                            { title: "Situação, o que", field: "situacaooque", width: 100 },
                            { title: "Situação, obs.", field: "situacaoobs", width: 100 },
                            { title: "Respon.ação", field: "responacao", width: 100 },
                            { title: "Ação", field: "acao", width: 100 },
                            { title: "Ação obs.", field: "acaobos", width: 100 },
                            { title: "Interessada", field: "interessada3", width: 100 },
                            { title: "Valor max.indenização", field: "valomaxind", width: 150 },
                            { title: "Fonte", field: "fonte", width: 100 },
                            { title: "Pagamento", field: "pagamento", width: 250 },
                            { title: "Data 2ª parcela indeniza.", field: "data2parc", width: 250 },
                            { title: "Valor pago contrapartida", field: "valorpagocontrapart", width: 250 },
                            { title: "Saldo contrapartida", field: "saldocontrapart", width: 250 },
                            { title: "Quantidade de casos", field: "quantdecasos", width: 250 },
                        ],
                        rowClick: function (e, row) { //eventos quando sobre uma linha
                            vepgeom.setStyle(estilopadrao);
                            poligonodtab.clearLayers();
                            let selecao = row.getIndex();
                            let filtradoobj = data.features.find(e => e.properties.id == selecao);
                            poligono = L.geoJSON(filtradoobj).addTo(poligonodtab).setStyle(estilodestaque);
                            $("#tabelatabulator").tabulator("deselectRow");
                            $("#tabelatabulator").tabulator("selectRow", selecao);
                            map.flyToBounds(poligono.getBounds());
                        },
                    });

                    $("#tabelatabulator").tabulator("setData", objtabela);
                });
            }
        });

        /*
        var legend = L.control({ position: 'bottomright' });

        legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info legend');
            div.innerHTML +=
                '<span class="dot" style="background-color: #00cc66;"></span> desapropriados recursos municipais' +
                '<br/>' +
                '<span class="dot" style="background-color: #00ffff;"></span> desapropriados TC-421/2010' +
                '<br/>' +
                '<span class="dot" style="background-color: #0000ff;"></span> matriculado em negociação' +
                '<br/>' +
                '<span class="dot" style="background-color: #ff99ff;"></span> matriculados não negociados' +
                '<br/>' +
                '<span class="dot" style="background-color: #f1e2cc;"></span> posse em negociação';
            return div;
        };
        legend.addTo(map);
        */

        //Sistema viário para pesquisa
        var pesquisa = new L.LayerGroup();
        $.getJSON("http://geo-smu.itajai.local:8080/geoserver/geoitj/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=geoitj:viewsistemaviariopts&outputFormat=application%2Fjson", function (data) { L.geoJson(data).addTo(pesquisa) });

        //Barra pesquisa
        var searchControl = new L.Control.Search({
            layer: pesquisa,
            propertyName: 'nome',
            circleLocation: false,
            marker: false,
            textPlaceholder: "Pesquisa nome logradouro",
            textErr: "Não localizado",
            textCancel: "Cancelar",
            zoom: 18,
            openPopup: false,
            collapsed: true,
            initial: false,
            position: 'topleft',
            minLength: 2
        });
        map.addControl(searchControl);
        //camada não precisa ser visível, apenas para searchcontrol
        map.removeLayer(pesquisa);

        //linha area atingida
        $.getJSON("http://10.10.1.158:8080/geoserver/geoitj/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=geoitj:vepareaating&outputFormat=application%2Fjson", function (data) {
            L.geoJson(data, {
                style: function (feature) {
                    return { color: "#ff0000", dashArray: "10 10", Opacity: 0.8 };
                }
            }).addTo(map);
        });

    </script>

</body>

</html>