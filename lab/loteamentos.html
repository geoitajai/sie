<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Loteamentos, Itajaí-SC</title>
	<link rel="icon" type="image/png" href="http://geo-smu.itajai.local/geo/images/favicon-96x96.png" sizes="96x96">
	<link rel="icon" type="image/png" href="http://geo-smu.itajai.local/geo/images/favicon-16x16.png" sizes="16x16">
	<link rel="icon" type="image/png" href="http://geo-smu.itajai.local/geo/images/favicon-32x32.png" sizes="32x32">
	<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
	<link rel="stylesheet" href="http://geo-smu.itajai.local/geo/lib/leaflet.css" />
	<link rel="stylesheet" href="http://geo-smu.itajai.local/geo/lib/leaflet.draw.css" />
	<link rel="stylesheet" href="http://geo-smu.itajai.local/geo/lib/leaflet-search.min.css" />
	<link rel="stylesheet" href="http://geo-smu.itajai.local/geo/lib/jquery-ui.min.css" />
	<link rel="stylesheet" href="http://geo-smu.itajai.local/geo/lib/tabulator.min.css" />
	<style>
		body {
			margin: 0;
			padding: 0;
		}

		#map {
			position: absolute;
			top: 0;
			width: 100%;
			height: 70%;
		}

		.leaflet-container {
			background: #ffffff;
		}

		.linhatabela {
			position: absolute;
			bottom: 0;
			width: 99.5%;
			height: 25%;
		}

		.botoestabela {
			position: absolute;
			bottom: 26%;
			background-color: #ffffff;
			z-index: 1000;
		}
	</style>
</head>

<body>
	<!-- Mapa -->
	<div id="map"></div>
	<!-- Botões de pesquisa -->
	<div class="botoestabela table-controls">
		<span>
			<select id="filter-field">
				<option value="nomeloteamento">Nome</option>
			</select>
		</span>

		<span>
			<input id="filter-value" type="text" placeholder="digite para filtrar">
		</span>

		<button id="filter-clear">Limpar</button>
	</div>
	<!-- Tabela -->
	<div class="linhatabela" id="tabelatabulator"></div>

	<!-- Bibliotecas -->
	<script src="http://geo-smu.itajai.local/geo/lib/jquery-3.3.1.min.js"></script>
	<script src="http://geo-smu.itajai.local/geo/lib/leaflet.js"></script>
	<script src="http://geo-smu.itajai.local/geo/lib/leaflet-search.min.js"></script>
	<script src="http://geo-smu.itajai.local/geo/lib/leaflet.draw.js"></script>
	<script src="http://geo-smu.itajai.local/geo/lib/leaflet.measurecontrol.min.js"></script>
	<script src="http://geo-smu.itajai.local/geo/lib/jquery-ui.min.js"></script>
	<script src="http://geo-smu.itajai.local/geo/lib/tabulator.min.js"></script>

	<!-- Filtros para a tabela -->
	<script>
		function customFilter(data) {
			return data.car && data.rating < 3;
		};

		//Composição do filtro
		function updateFilter() {

			let filter = $("#filter-field").val() == "function" ? customFilter : $("#filter-field").val();

			if ($("#filter-field").val() == "function") {
				$("#filter-type").prop("disabled", true);
				$("#filter-value").prop("disabled", true);
			} else {
				$("#filter-type").prop("disabled", false);
				$("#filter-value").prop("disabled", false);
			}

			$("#tabelatabulator").tabulator("setFilter", filter, "like", $("#filter-value").val());
		};

		//Atualiza o filtro ao mudar os valores
		$("#filter-field, #filter-type").change(updateFilter);
		$("#filter-value").keyup(updateFilter);

		//Botão reiniciar os valores
		$("#filter-clear").click(function () {
			$("#filter-field").val("nome");
			$("#filter-value").val("");

			$("#tabelatabulator").tabulator("clearFilter");
		});
	</script>

	<script>

		//controle de layers
		var areasmunicip = L.layerGroup();
		var areascaucionadas = L.layerGroup();

		//div do mapa
		var map = new L.Map('map', {
			zoom: 14,
			minZoom: 12,
			maxZoom: 20,
			maxBounds: [
				//south west
				[-27.1279, -48.8954],
				//north east
				[-26.8074, -48.5845]
			],
			center: new L.latLng([-26.906960, -48.685425]),
			maxBoundsViscosity: 1.0,
			zoomControl: false
		});

		//barra escala
		L.control.scale({ imperial: false, position: 'bottomright' }).addTo(map);

		//Norte
		var titulomapa = L.control({ position: 'bottomright' });

		titulomapa.onAdd = function (map) {
			var div = L.DomUtil.create('div', 'info legend');
			div.innerHTML +=
				'<center><sub><font size="4">▲</font></sub><br/>' +
				'<sup><font size="2">N</font></sup></center>'
			return div;
		};
		titulomapa.addTo(map);

		//marca, logo município smu
		L.Control.Watermark = L.Control.extend({
			onAdd: function (map) {
				let img = L.DomUtil.create('img');

				img.src = 'http://geo-smu.itajai.local/geo/images/smuloteamentos.png';
				img.style.width = '250px';

				return img;
			},

			onRemove: function (map) {
				// Nada a fazer aqui
			}
		});

		L.control.watermark = function (opts) {
			return new L.Control.Watermark(opts);
		}

		L.control.watermark({ position: 'topleft' }).addTo(map);

		//Mapa base, google
		map.addLayer(new L.TileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
			opacity: 0.7,
			maxZoom: 20,
			transparent: false,
			attribution: 'Levantamento loteamentos, Itajaí-SC,<a href="mailto:jaceguay@itajai.sc.gov.br?Subject=WebGIS" target="_top">SIE</a>',
			subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
		}));

		//Mapa base, viário
		var wmsLayer = L.tileLayer.wms('http://10.10.1.158:8080/geoserver/ows?', {
			layers: 'geoitj:viewsistemaviarioestilosempauta',
			format: 'image/png8',
			opacity: 0.5,
			minZoom: 15,
			maxZoom: 20,
			attribution: false,
			transparent: true
		}).addTo(map);

		//Mapa base, lotes
		var lotcad = L.tileLayer.wms('http://10.10.1.158:8080/geoserver/ows?', {
			layers: 'geoitj:viewcadastrovias',
			format: 'image/png',
			opacity: 0.2,
			minZoom: 15,
			maxZoom: 20,
			attribution: false,
			transparent: true
		}).addTo(map);

		//perímetro urbano
		$.getJSON("http://geo-smu.itajai.local:8080/geoserver/geoitj/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=geoitj:perimetrourbano79&outputFormat=application%2Fjson", function (data) {
			L.geoJson(data, {
				style: function (feature) {
					return { color: "#1a1a1a", dashArray: "10 10", Opacity: 0.8, weight: 2 };
				},
				onEachFeature: function (feature, layer) {
					layer.bindPopup(
						'Perímetro urbano, leis 1764/79 e 4157/04'
					);
				}
			}).addTo(map);
		});

		//Loteamentos georreferenciados
		//32a - Lot.Nilo Bittencourt - 1ºparte
		var l32a = new L.LayerGroup();
		new L.TileLayer('http://geo-smu.itajai.local/geo/ortoimagens/loteamentosgeorref/32a/{z}/{x}/{y}.png', {
			opacity: 0.5,
			minZoom: 15,
			maxZoom: 20
		}).addTo(l32a);

		//32a - Lot.Nilo Bittencourt - 2ºparte
		var l32b = new L.LayerGroup();
		new L.TileLayer('http://geo-smu.itajai.local/geo/ortoimagens/loteamentosgeorref/32b/{z}/{x}/{y}.png', {
			opacity: 0.5,
			minZoom: 15,
			maxZoom: 20
		}).addTo(l32b);

		//163 - Jardim Copas do Vale
		var l163 = new L.LayerGroup();
		new L.TileLayer('http://geo-smu.itajai.local/geo/ortoimagens/loteamentosgeorref/163/{z}/{x}/{y}.png', {
			opacity: 0.5,
			minZoom: 15,
			maxZoom: 20
		}).addTo(l163);

		//166a - Vila 1º de Maio - 1ºparte
		var l166a = new L.LayerGroup();
		new L.TileLayer('http://geo-smu.itajai.local/geo/ortoimagens/loteamentosgeorref/166a/{z}/{x}/{y}.png', {
			opacity: 0.5,
			minZoom: 15,
			maxZoom: 20
		}).addTo(l166a);

		//166a - Vila 1º de Maio - 2ºparte
		var l166b = new L.LayerGroup();
		new L.TileLayer('http://geo-smu.itajai.local/geo/ortoimagens/loteamentosgeorref/166b/{z}/{x}/{y}.png', {
			opacity: 0.5,
			minZoom: 15,
			maxZoom: 20
		}).addTo(l166b);

		//225 - Pedro Paulo Rebello
		var l225 = new L.LayerGroup();
		new L.TileLayer('http://geo-smu.itajai.local/geo/ortoimagens/loteamentosgeorref/225/{z}/{x}/{y}.png', {
			opacity: 0.5,
			minZoom: 15,
			maxZoom: 20
		}).addTo(l225);

		//250a - Leopoldo Zarling, Imaruí - Prancha2
		var l250a = new L.LayerGroup();
		new L.TileLayer('http://geo-smu.itajai.local/geo/ortoimagens/loteamentosgeorref/250a/{z}/{x}/{y}.png', {
			opacity: 0.6,
			minZoom: 15,
			maxZoom: 20
		}).addTo(l250a);

		//250b - Leopoldo Zarling, Imaruí - Prancha1
		var l250b = new L.LayerGroup();
		new L.TileLayer('http://geo-smu.itajai.local/geo/ortoimagens/loteamentosgeorref/250b/{z}/{x}/{y}.png', {
			opacity: 0.6,
			minZoom: 15,
			maxZoom: 20
		}).addTo(l250b);

		//Botão zoom posicionado
		L.control.zoom({ position: 'topleft' }).addTo(map);

		//Loteamentos
		var loteamentos = L.geoJson(false, {

			style: function (feature) {
				//cor do preenchimento
				let corpreench = feature.properties.pendencia;
				if (corpreench == 's') corpreench = "#e6e6e6";
				else corpreench = "#9933ff";
				//cor da linha
				let corlinha = feature.properties.pendencia;
				if (corlinha == 's') corlinha = "#e6e6e6";
				else corlinha = "#000";
				return { fillColor: corpreench, color: corlinha, weight: 1 };
			},
			onEachFeature: function (feature, layer) {
				layer.bindPopup(
					'<strong>' + feature.properties.nomeloteamento + '</strong>' + '<br/>' +
					'Tipo: ' + feature.properties.tipo + ' - Setor: ' + feature.properties.setor + '<br/>' +
					'Bairro: ' + feature.properties.bairro + '<br/>' +
					'<a href="http://10.10.1.158/geo/images/loteamentos/' + feature.properties.codigo + '.pdf" target="_blank">ABRIR PLANTA</a>'
				);
			}
		});

		$.getJSON("http://10.10.1.158:8080/geoserver/geoitj/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=geoitj:viewloteamentos&outputFormat=application%2Fjson", function (data) {

			let vepgeom = L.geoJSON().addTo(map);//mapa
			let poligonodtab = L.geoJSON().addTo(map);//destaque seleção a partir da tabela

			let estilopadrao = (feature) => {
				return {
					weight: 1,
					color: '#cc3300',
					dashArray: null
				};
			}

			let estilodestaque = {
				weight: 5,
				dashArray: '6',
				color: 'black'
			};

			let destacarfeicao = (e) => {
				vepgeom.setStyle(estilopadrao);
				poligonodtab.clearLayers();
				var layersel = e.target;
				layersel.setStyle(estilodestaque);
				let rowid = e.sourceTarget.feature.properties.id;
				$("#tabelatabulator").tabulator("deselectRow");
				$("#tabelatabulator").tabulator("scrollToRow", rowid, "center", false);
				$("#tabelatabulator").tabulator("selectRow", rowid);
			};

			L.geoJson(data, {
				style: (feature, layer) => {
					return { weight: 1, color: '#cc3300', fillColor: '#9999ff', fillOpacity: 0.4, weight: 1 };
				},
				onEachFeature: (feature, layer) => {
					layer.on({ click: destacarfeicao });
					layer.bindPopup(
						'<strong>' + feature.properties.nomeloteamento + '</strong>' + '<br/>' +
						'Tipo: ' + feature.properties.tipo + ' - Setor: ' + feature.properties.setor + '<br/>' +
						'Bairro: ' + feature.properties.bairro + '<br/>' +
						'<a href="http://10.10.1.158/geo/images/loteamentos/' + feature.properties.codigo + '.pdf" target="_blank">ABRIR PLANTA</a>'
					);
				},

			}).addTo(vepgeom);

			//Tabela map()
			let datafeatures = data.features;
			let objtabela = datafeatures.map((feicoes) => {
				return {
					'id': feicoes.properties.id,
					'nomeloteamento': feicoes.properties.nomeloteamento,
					'tipo': feicoes.properties.tipo,
					'bairro': feicoes.properties.bairro,
					'setor': feicoes.properties.setor,
					'link': '<a href="http://10.10.1.158/geo/images/loteamentos/' + feicoes.properties.codigo + '.pdf" target="_blank">ABRIR PLANTA</a>'
				}
			});

			//tabela
			$("#tabelatabulator").tabulator({
				height: "25%",
				layout: "fitColumns",
				columns: [
					{ title: "Nome", field: "nomeloteamento", width: 400 },
					{ title: "Tipo", field: "tipo", width: 150 },
					{ title: "Bairro", field: "bairro", width: 200 },
					{ title: "Setor", field: "setor", width: 70 },
					{ title: "Prancha", field: "link", formatter: "html", width: 120 },
				],
				rowClick: function (e, row) { //eventos quando sobre uma linha
					vepgeom.setStyle(estilopadrao);
					poligonodtab.clearLayers();
					let selecao = row.getIndex();
					let filtradoobj = data.features.find(e => e.properties.id == selecao);
					poligono = L.geoJSON(filtradoobj).addTo(poligonodtab).setStyle(estilodestaque);
					$("#tabelatabulator").tabulator("deselectRow");
					$("#tabelatabulator").tabulator("selectRow", selecao);
					map.flyToBounds(poligono.getBounds());
				},
			});

			$("#tabelatabulator").tabulator("setData", objtabela);

		});

		//Sistema viário, pesquisa
		var pesquisa = new L.LayerGroup();
		$.getJSON("http://geo-smu.itajai.local:8080/geoserver/geoitj/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=geoitj:viewsistemaviariopts&outputFormat=application%2Fjson", function (data) { L.geoJson(data).addTo(pesquisa) });
		//Searchcontrol para vias e loteamentos
		var searchControl = new L.Control.Search({
			layer: pesquisa,
			propertyName: 'nome',
			circleLocation: false,
			marker: false,
			textPlaceholder: "Pesquisa nome logradouro ou loteamento",
			textErr: "Não localizado",
			textCancel: "Cancelar",
			zoom: 18,
			openPopup: false,
			collapsed: true,
			initial: false,
			position: 'topleft',
			minLength: 2
		});
		map.addControl(searchControl);
		map.removeLayer(pesquisa);

		//Áreas do município
		$.getJSON("http://10.10.1.158:8080/geoserver/geoitj/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=geoitj:viewloteamentoareasmunicip&outputFormat=application%2Fjson", function (data) {
			L.geoJson(data, {
				style: function (feature) {
					return {
						fillColor: "#ff3300",
						color: "#4d0f00",
						fillOpacity: 0.4
					};
				},

				onEachFeature: function (feature, layer) {
					layer.bindPopup(
						feature.properties.tipo
					);
				}
			}).addTo(areasmunicip);
		});

		//Áreas caucionadas
		$.getJSON("http://10.10.1.158:8080/geoserver/geoitj/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=geoitj:loteamentoslotescaucionados&outputFormat=application%2Fjson", function (data) {
			L.geoJson(data, {
				style: function (feature) {
					return {
						fillColor: "#ffff00",
						color: "#808000",
						fillOpacity: 0.4
					};
				},

				onEachFeature: function (feature, layer) {
					layer.bindPopup(
						'Descrição: ' + feature.properties.nome + '<br/>' +
						'Lei: ' + feature.properties.lei
					);
				}
			}).addTo(areascaucionadas);
		});

		//Controle de camadas 1
		var overlay = {
			"Áreas município": areasmunicip,
			"Lotes, cadastro": lotcad,
			"Lotes caucionados": areascaucionadas
		};

		L.control.layers(null, overlay, { collapsed: false, position: 'topleft' }).addTo(map);

		//Controle de camadas
		var overlay2 = {
			"Lot.Nilo Bittencourt - 1ºparte": l32a,
			"Lot.Nilo Bittencourt - 2ºparte": l32b,
			"Lot.Jardim Copas do Vale": l163,
			"Lot.Vila 1º de Maio - 1ºparte": l166a,
			"Lot.Vila 1º de Maio - 2ºparte": l166b,
			"Lot.Pedro Paulo Rebello": l225,
			"Lot.Leopoldo Zarling, Imaruí - PranchaB": l250a,
			"Lot.Leopoldo Zarling, Imaruí - PranchaA": l250b
		};

		L.control.layers(null, overlay2, { collapsed: true, position: 'topleft' }).addTo(map);

		//Limites Município
		$.getJSON("http://10.10.1.158:8080/geoserver/geoitj/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=geoitj:geo2007limitesmunicip&outputFormat=application%2Fjson", function (data) {
			L.geoJson(data, {
				style: function (feature) {
					return {
						color: '#000000',
						fill: false
					};
				},
			}).addTo(map);
		});

	</script>
</body>

</html>