
<div class="mapa" id="mapa"></div>

<script>
    //div do mapa
    let mapa = new L.Map('mapa', {
        zoom: 14,
        minZoom: 11,
        maxZoom: 20,
        maxBounds: [
            //south west
            [-27.3000, -49.2300],
            //north east
            [-26.3285, -48.3200]
        ],
        center: new L.latLng([-26.9046, -48.6874]),
        zoomControl: false,
        renderer: L.canvas()
    });

    //barra escala
    L.control.scale({ position: "bottomright", imperial: false }).addTo(mapa);

    //Norte
    let nortemapa = L.control({ position: 'bottomright' });

    nortemapa.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'info2 legend');
        div.innerHTML +=
            '<center><sub><font size="4">▲</font></sub><br/>' +
            '<sup><font size="2">N</font></sup></center>'
        return div;
    };
    nortemapa.addTo(mapa);

    //Botão zoom posicionado
    L.control.zoom({ position: 'topright' }).addTo(mapa);

    //Mapa base, google
    new L.TileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
        opacity: 0.6,
        maxZoom: 20,
        transparent: false,
        attribution: '©2018 Google, Itajaí/SC, <a href="mailto:jaceguay@itajai.sc.gov.br?Subject=WebGIS" target="_top">SIE</a>',
        subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
    }).addTo(mapa);

    //camada planta cadastral que irá receber os lotes
    let plantacadastral = L.layerGroup();
    mapa.on('zoomend', function () {
        if (mapa.getZoom() < 18) {
            mapa.removeLayer(plantacadastral);
        }
        else {
            mapa.addLayer(plantacadastral);
        }
    });

    //navegação articulação com indice > carregar planta
    let plantaindice = [];
    $.getJSON("data/articula.json", (data) => {

        let articulabbox = data.map((feicoes) => {
            return {
                'sw': [Number(feicoes.y2), Number(feicoes.x2)],
                'ne': [Number(feicoes.y), Number(feicoes.x)],
                'nome': feicoes.nome
            }
        });

        mapa.on('moveend', () => {
            if (mapa.getZoom() >= 18) {
                let filtradoobj = articulabbox
                    .filter((e) => {
                        return mapa.getBounds().intersects(L.latLngBounds(e.sw, e.ne)) === true
                    })
                    .forEach(x => {
                        if (plantaindice.includes(x.nome) === false) {
                            $.getJSON("data/divisaolotes/export/" + x.nome + ".geojson", (data) => {
                                L.geoJson(data).addTo(plantacadastral);
                            });
                            plantaindice.push(x.nome);
                        }
                    });
            }
        });
    });

</script>



