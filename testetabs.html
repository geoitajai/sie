<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title> </title>
    <link rel="icon" type="image/png" href="images/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="images/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="images/favicon-32x32.png" sizes="32x32">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <link rel="stylesheet" href="lib/leaflet.css" />
    <link rel="stylesheet" href="lib/jquery-ui.min.css" />
    <link rel="stylesheet" href="lib/tabulator.min.css" />
</head>

<style>
    body {
        margin: 0;
        padding: 0;
    }

    #map {
        position: absolute;
        top: 25;
        width: 100%;
        height: 70%;
    }

    .leaflet-container {
        background: #ffffff;
    }

    /* Style the tab */

    .tab {
        overflow: hidden;
        background-color: #f1f1f1;
        position: absolute;
        bottom: 0;
        width: 100%;
        height: 30%;
    }

    /* Style the buttons that are used to open the tab content */

    .tab button {
        background-color: inherit;
        float: left;
        border: none;
        outline: none;
        cursor: pointer;
        padding: 5px 6px;
        transition: 0.3s;
    }

    /* Change background color of buttons on hover */

    .tab button:hover {
        background-color: #ddd;
    }

    /* Create an active/current tablink class */

    .tab button.active {
        background-color: #ccc;
    }

    /* Style the tab content */

    .tabcontent {
        display: none;
        /* padding: 3px 6px; */
        border: none;
        position: absolute;
        bottom: 0;
        width: 99.5%;
        height: 25%;
    }

    .botoestabela {
        position: absolute;
        float: left;
        bottom: 95%;
        padding: 5px 6px;
        /* z-index: 1000; */
    }

    .linhatabela {
        position: absolute;
        top: 6%;
        width: 99.9%;
        /* height: 100%; */
    }
</style>

<body>

    <!-- Tab links -->
    <div class="tab">
        <button class="tablinks" onclick="openCity(event, 'London')" id="defaultOpen">London</button>
        <button class="tablinks" onclick="openCity(event, 'Paris')">Paris</button>
        <button class="tablinks" onclick="openCity(event, 'Tokyo')">Tokyo</button>
    </div>

    <!-- Tab content -->
    <div id="London" class="tabcontent">
        <!-- Botões de pesquisa -->
        <div class="botoestabela table-controls">
            <span>
                <select id="filter-field">
                    <option value="end">End.</option>
                </select>
            </span>
            <span>
                <input id="filter-value" type="text" placeholder="digite para filtrar">
            </span>

            <button id="filter-clear">Limpar</button>
        </div>
        <!-- Tabela -->
        <div class="linhatabela" id="tabelatabulator"></div>
    </div>

    <div id="Paris" class="tabcontent">
        <h3>Paris</h3>
        <p>Paris is the capital of France.</p>
    </div>

    <div id="Tokyo" class="tabcontent">
        <h3>Tokyo</h3>
        <p>Tokyo is the capital of Japan.</p>
    </div>

    <!-- Mapa -->
    <div id="map"></div>

    <!-- Bibliotecas -->
    <script src="lib/leaflet.js"></script>
    <script src="lib/jquery-3.3.1.min.js"></script>
    <script src="lib/jquery-ui.min.js"></script>
    <script src="lib/tabulator.min.js"></script>

    <!-- Filtros para a tabela -->
    <script>
        function customFilter(data) {
            return data.car && data.rating < 3;
        };

        //Composição do filtro
        function updateFilter() {

            var filter = $("#filter-field").val() == "function" ? customFilter : $("#filter-field").val();

            if ($("#filter-field").val() == "function") {
                $("#filter-type").prop("disabled", true);
                $("#filter-value").prop("disabled", true);
            } else {
                $("#filter-type").prop("disabled", false);
                $("#filter-value").prop("disabled", false);
            }

            $("#tabelatabulator").tabulator("setFilter", filter, "like", $("#filter-value").val());
        };

        //Atualiza o filtro ao mudar os valores
        $("#filter-field, #filter-type").change(updateFilter);
        $("#filter-value").keyup(updateFilter);

        //Botão reiniciar os valores
        $("#filter-clear").click(function () {
            $("#filter-field").val("end");
            $("#filter-type").val("like");
            $("#filter-value").val("");

            $("#tabelatabulator").tabulator("clearFilter");
        });
    </script>

    <!-- Mapa -->
    <script>
        //tabs
        function openCity(evt, cityName) {
            // Declare all variables
            var i, tabcontent, tablinks;

            // Get all elements with class="tabcontent" and hide them
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }

            // Get all elements with class="tablinks" and remove the class "active"
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }

            // Show the current tab, and add an "active" class to the button that opened the tab
            document.getElementById(cityName).style.display = "block";
            evt.currentTarget.className += " active";
        }
        // Get the element with id="defaultOpen" and click on it
        document.getElementById("defaultOpen").click();

        //div do mapa
        var map = new L.Map('map', {
            zoom: 14,
            minZoom: 12,
            maxZoom: 19,
            maxBounds: [
                //south west
                [-27.215341, -49.020370],
                //north east
                [-26.701009, -48.397961]
            ],
            center: new L.latLng([-26.906960, -48.685425])
        });

        //barra escala
        L.control.scale({ position: "bottomright", imperial: false }).addTo(map);

        //Norte
        var north = L.control({ position: "bottomright" });
        north.onAdd = function (map) {
            var div = L.DomUtil.create("div", "info legend");
            div.innerHTML = '<img src="images/setanorte.png">';
            return div;
        }
        north.addTo(map);

        //google image
        new L.TileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            opacity: 0.6,
            maxZoom: 19,
            transparent: false,
            attribution: '©2018 Google, SMU/Porto, <a href="mailto:jaceguay@itajai.sc.gov.br?Subject=WebGIS" target="_top">SIE</a>',
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
        }).addTo(map);

        //Avaliações
        $.ajax({
            type: "GET",
            url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSfmnhu6-ia1AQmoO5eKO3cuwyReuRnqXwShzz0CcDI7SZ7SeNmbzt6JfXjXuXsbYngjSQE99Gzu10g/pub?gid=0&single=true&output=tsv",
            dataType: "text",
            success: function (data) {

                let tabelalinhas = data.split('\n').map(linha => linha.split('\t'));//separa as linhas
                let cabecalho = tabelalinhas.shift();//remove a primeira linha, retorna o cabeçalho
                let tabelaindex = tabelalinhas.reduce((total, numero, indice) => [numero.push(indice)], 0);//adiciona o campo id, gerado feicoes[15]
                console.log(tabelalinhas);
                //Pontos map()
                let objgeometria = tabelalinhas.map((feicoes) => {
                    return {
                        'features': [{
                            'type': 'Feature',
                            'properties': {
                                'nome': feicoes[0],
                                //'map': feicoes[7],
                                'id': feicoes[19]
                            },
                            'geometry': {
                                'type': 'Point',
                                'coordinates': [
                                    feicoes[18],
                                    feicoes[17]
                                ]
                            }
                        }]
                    }
                });

                //estilo ícone
                let markicon = L.icon({
                    iconUrl: 'images/dotb.png',
                    iconAnchor: [8, 8],
                    popupAnchor: [0, -8],
                    iconSize: [14, 14]
                });

                //pontos para mapa
                L.geoJSON(objgeometria, {
                    'pointToLayer': function (feature, latlng) {
                        let rowid = feature.properties.id;
                        return L.marker(latlng)
                            .bindPopup(
                                '<center>' + feature.properties.nome + '</center>'
                            )
                            .setIcon(markicon)
                            .on('popupopen', function (popup) {
                                $("#tabelatabulator").tabulator("deselectRow");
                                $("#tabelatabulator").tabulator("scrollToRow", rowid, "center", false);
                                $("#tabelatabulator").tabulator("selectRow", rowid);
                            }).addTo(map);
                    }
                });

                //Tabela map()
                let objtabela = tabelalinhas.map((feicoes) => {
                    return {
                        'nome': feicoes[0],
                        'end': feicoes[1],
                        'test': feicoes[2],
                        'prof': feicoes[3],
                        'areaterr': feicoes[4],
                        'areaav': feicoes[5],
                        'valortotalarea': feicoes[6],
                        'valorbenf': feicoes[7],
                        'valorterre': feicoes[8],
                        'valormq': feicoes[9],
                        'porcento': feicoes[10] * 100,
                        'zon': feicoes[12],
                        'datavalia': feicoes[13],
                        'inform': feicoes[14],
                        'contato': feicoes[15],
                        'obs': feicoes[16],
                        'id': feicoes[19]
                    }
                });

                //Tabela
                $("#tabelatabulator").tabulator({
                    height: "90%",
                    layout: "fitColumns",
                    columns: [
                        { title: "N.", field: "nome", width: 40 },
                        { title: "Endereço", field: "end", width: 360 },
                        { title: "Testada", field: "test", width: 70 },
                        { title: "Profundidade", field: "prof", width: 70 },
                        { title: "Área total", field: "areaterr", width: 100 },
                        { title: "Área avaliada", field: "areaav", width: 120 },
                        { title: "Total avaliado", field: "valortotalarea", width: 120 },
                        { title: "Benfeitoria", field: "valorbenf", width: 120 },
                        { title: "Terreno", field: "valorterre", width: 120 },
                        { title: "Terreno/m²", field: "valormq", width: 120 },
                        { title: "% do maior valor", field: "porcento", align: "left", formatter: "progress", width: 70 },
                        { title: "Data avaliação", field: "datavalia", sorter: "date", align: "center", width: 110 },
                        { title: "Zoneamento", field: "zon", width: 110 },
                        { title: "Informante", field: "inform", width: 120 },
                        { title: "Contato", field: "contato", width: 90 },
                        { title: "Observações", field: "obs", width: 150 },
                    ],
                    rowClick: function (e, row) { //eventos quando sobre uma linha
                        let selecao = row.getIndex();
                        let latelong = [objgeometria[selecao].features[0].geometry.coordinates[1], objgeometria[selecao].features[0].geometry.coordinates[0]];
                        let popnome = objgeometria[selecao].features[0].properties.nome;

                        $("#tabelatabulator").tabulator("deselectRow");
                        $("#tabelatabulator").tabulator("selectRow", selecao);

                        map.flyTo(latelong, 18);

                        L.popup({ maxWidth: 5 })
                            .setLatLng(latelong)
                            .setContent('<center>' + popnome + '</center>')
                            .openOn(map);
                    },
                });

                $("#tabelatabulator").tabulator("setData", objtabela);
            }
        });

    </script>

</body>

</html>